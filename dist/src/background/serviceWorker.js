var j=Object.defineProperty;var N=(t,e,n)=>e in t?j(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var p=(t,e,n)=>N(t,typeof e!="symbol"?e+"":e,n);const W="modulepreload",K=function(t){return"/"+t},M={},A=function(e,n,a){let r=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),c=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));r=Promise.allSettled(n.map(l=>{if(l=K(l),l in M)return;M[l]=!0;const u=l.endsWith(".css"),g=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${g}`))return;const m=document.createElement("link");if(m.rel=u?"stylesheet":W,u||(m.as="script"),m.crossOrigin="",m.href=l,c&&m.setAttribute("nonce",c),document.head.appendChild(m),u)return new Promise((h,d)=>{m.addEventListener("load",h),m.addEventListener("error",()=>d(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(s){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=s,window.dispatchEvent(c),!c.defaultPrevented)throw s}return r.then(s=>{for(const c of s||[])c.status==="rejected"&&i(c.reason);return e().catch(i)})};var R=(t=>(t[t.DEBUG=0]="DEBUG",t[t.INFO=1]="INFO",t[t.WARN=2]="WARN",t[t.ERROR=3]="ERROR",t))(R||{});class G{constructor(){p(this,"currentLevel",1);p(this,"logs",[]);p(this,"maxLogs",1e3)}setLevel(e){this.currentLevel=e}getLevel(){return this.currentLevel}debug(e,n){this.log(0,e,n)}info(e,n){this.log(1,e,n)}warn(e,n){this.log(2,e,n)}error(e,n,a){this.log(3,e,{...a,error:n})}log(e,n,a){if(e<this.currentLevel)return;const r={timestamp:new Date().toISOString(),level:e,message:n,context:a};this.logs.push(r),this.logs.length>this.maxLogs&&this.logs.shift();const i=this.formatMessage(r);switch(e){case 0:console.debug(i,a);break;case 1:console.info(i,a);break;case 2:console.warn(i,a);break;case 3:console.error(i,a);break}e>=2&&this.storeInChromeStorage(r)}formatMessage(e){const n=R[e.level];return`[${new Date(e.timestamp).toLocaleTimeString()}] [${n}] ${e.message}`}async storeInChromeStorage(e){try{const a=(await chrome.storage.local.get(["logs"])).logs||[];a.push(e),a.length>50&&a.splice(0,a.length-50),await chrome.storage.local.set({logs:a})}catch(n){console.error("Failed to store log in Chrome storage:",n)}}getLogs(e=100){return this.logs.slice(-e)}clearLogs(){this.logs=[]}async getStoredLogs(){try{return(await chrome.storage.local.get(["logs"])).logs||[]}catch(e){return console.error("Failed to get stored logs:",e),[]}}async clearStoredLogs(){try{await chrome.storage.local.remove(["logs"])}catch(e){console.error("Failed to clear stored logs:",e)}}}const o=new G,T={defaultLanguage:"English",defaultTone:"professional",defaultSummaryLength:"medium",preferredProvider:"chrome",autoCache:!0,showDebugInfo:!1,keyboardShortcuts:!0,popupPosition:"top",theme:"auto",animations:!0,soundEffects:!1,autoExpandPopup:!1,contextWindowSize:1e3},E={requestTimeout:3e4,maxRetries:3,rateLimit:{requestsPerMinute:60,requestsPerHour:1e3}},w={user:T,providers:E,lastUpdated:Date.now(),version:"1.0.0"};class H{constructor(){p(this,"settings",w);p(this,"isInitialized",!1)}async initialize(){try{const e=await chrome.storage.sync.get(["appSettings"]);e.appSettings?(this.settings={...w,...e.appSettings},o.debug("Settings loaded from storage",{version:this.settings.version,lastUpdated:new Date(this.settings.lastUpdated).toISOString()})):(await this.saveSettings(),o.debug("Default settings initialized")),this.isInitialized=!0}catch(e){o.error("Failed to initialize settings",e),this.settings=w,this.isInitialized=!0}}getSettings(){return{...this.settings}}getUserSettings(){return{...this.settings.user}}getProviderSettings(){return{...this.settings.providers}}async updateUserSettings(e){try{this.settings.user={...this.settings.user,...e},this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.info("User settings updated",{updates:Object.keys(e),timestamp:new Date(this.settings.lastUpdated).toISOString()})}catch(n){throw o.error("Failed to update user settings",n,{updates:e}),n}}async updateProviderSettings(e){try{this.settings.providers={...this.settings.providers,...e},this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.info("Provider settings updated",{updates:Object.keys(e),timestamp:new Date(this.settings.lastUpdated).toISOString()})}catch(n){throw o.error("Failed to update provider settings",n,{updates:e}),n}}getDefaultPromptOptions(){return{targetLanguage:this.settings.user.defaultLanguage,tone:this.settings.user.defaultTone,summaryLength:this.settings.user.defaultSummaryLength}}async resetSettings(){try{this.settings={...w},await this.saveSettings(),o.info("Settings reset to defaults")}catch(e){throw o.error("Failed to reset settings",e),e}}exportSettings(){return JSON.stringify(this.settings,null,2)}async importSettings(e){try{const n=JSON.parse(e);if(!n.user||!n.providers)throw new Error("Invalid settings format");this.settings={user:{...T,...n.user},providers:{...E,...n.providers},lastUpdated:Date.now(),version:n.version||w.version},await this.saveSettings(),o.info("Settings imported successfully",{version:this.settings.version})}catch(n){throw o.error("Failed to import settings",n),n}}async saveSettings(){try{await chrome.storage.sync.set({appSettings:this.settings}),o.debug("Settings saved to storage")}catch(e){throw o.error("Failed to save settings to storage",e),e}}isReady(){return this.isInitialized}getSettingValue(e){const n=e.split(".");let a=this.settings;for(const r of n)if(a&&typeof a=="object"&&r in a)a=a[r];else return;return a}async setSettingValue(e,n){const a=e.split("."),r=a.pop();let i=this.settings;for(const s of a)(!i[s]||typeof i[s]!="object")&&(i[s]={}),i=i[s];i[r]=n,this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.debug("Setting value updated",{path:e,value:n})}}const $=new H;function y(){return $.getDefaultPromptOptions()}const U=Object.freeze(Object.defineProperty({__proto__:null,defaultAppSettings:w,defaultProviderSettings:E,defaultUserSettings:T,getDefaultPromptOptions:y,settingsManager:$},Symbol.toStringTag,{value:"Module"}));var P={};const k={ai:{provider:"chrome",openai:{apiKey:P.OPENAI_API_KEY||"",model:"gpt-3.5-turbo",baseUrl:"https://api.openai.com/v1"},chrome:{model:"gemini-pro"},gemini:{apiKey:P.GEMINI_API_KEY||"",model:"gemini-pro"}},limits:{maxTextLength:5e3,maxCacheEntries:100,cacheTtl:24*60*60*1e3},features:{enableCaching:!0,enableLogging:!0,enableFallback:!0}};async function S(){try{const t=await chrome.storage.sync.get(["config"]);return{...k,...t.config}}catch(t){return console.warn("Failed to load config from storage, using defaults:",t),k}}async function v(t){const e=await S();try{if(e.ai.provider==="chrome"&&chrome.ai){o.debug("Attempting Chrome AI API call",{model:e.ai.chrome.model});const n=await V(t,e.ai.chrome.model);return o.info("Chrome AI API call successful",{provider:"chrome",model:e.ai.chrome.model,responseLength:n.text.length}),n}if(console.log("[MuseFlow] Chrome AI not available, trying fallback providers..."),e.features.enableFallback&&e.ai.openai.apiKey){o.debug("Falling back to OpenAI API",{model:e.ai.openai.model});const n=await B(t,e.ai.openai);return o.info("OpenAI API call successful",{provider:"openai",model:e.ai.openai.model,responseLength:n.text.length}),n}if(e.features.enableFallback&&e.ai.gemini.apiKey){o.debug("Falling back to Gemini API",{model:e.ai.gemini.model});const n=await J(t,e.ai.gemini);return o.info("Gemini API call successful",{provider:"gemini",model:e.ai.gemini.model,responseLength:n.text.length}),n}throw new Error("No AI provider available")}catch(n){throw o.error("AI API call failed",n,{provider:e.ai.provider,request:{promptLength:t.prompt.length}}),n}}async function V(t,e){var n;if(!chrome.ai)throw new Error("Chrome AI API not available");try{if(console.log("[MuseFlow] Using real Chrome AI API with model:",e),chrome.ai.languageModel){console.log("[MuseFlow] Creating Chrome AI language model...");const a=await chrome.ai.languageModel.create({model:e||"gemini-pro"});console.log("[MuseFlow] Model created, generating response...");const r=await a.prompt(t.prompt,{temperature:t.temperature||.7,maxTokens:t.maxTokens||500,topP:.9});return console.log("[MuseFlow] Chrome AI response received:",r.response),{text:r.response,model:e||"gemini-pro",provider:"chrome",timestamp:new Date().toISOString(),tokensUsed:(n=r.usage)==null?void 0:n.totalTokens}}if(chrome.ai.summarizer){console.log("[MuseFlow] Using Chrome AI summarizer...");const a=await chrome.ai.summarizer.summarize(t.prompt,{length:"medium",format:"paragraph"});return console.log("[MuseFlow] Chrome AI summarizer response:",a.summary),{text:a.summary,model:e||"gemini-pro",provider:"chrome",timestamp:new Date().toISOString()}}throw new Error("No Chrome AI APIs available - neither languageModel nor summarizer")}catch(a){throw console.error("[MuseFlow] Chrome AI API call failed:",a),new Error(`Chrome AI API call failed: ${a}`)}}async function B(t,e){var r,i,s,c;const n=await fetch(`${e.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.model,messages:[{role:"user",content:t.prompt}],max_tokens:t.maxTokens||1e3,temperature:t.temperature||.7})});if(!n.ok){const l=await n.json().catch(()=>({}));throw new Error(`OpenAI API error: ${n.status} ${((r=l.error)==null?void 0:r.message)||n.statusText}`)}const a=await n.json();return{text:((s=(i=a.choices[0])==null?void 0:i.message)==null?void 0:s.content)||"",model:e.model,provider:"openai",timestamp:new Date().toISOString(),tokensUsed:(c=a.usage)==null?void 0:c.total_tokens}}async function J(t,e){var r,i,s,c;const n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${e.model}:generateContent?key=${e.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:t.prompt}]}],generationConfig:{temperature:t.temperature||.7,maxOutputTokens:t.maxTokens||1e3}})});if(!n.ok){const l=await n.json().catch(()=>({}));throw new Error(`Gemini API error: ${n.status} ${((r=l.error)==null?void 0:r.message)||n.statusText}`)}return{text:((c=(s=(i=(await n.json()).candidates[0])==null?void 0:i.content)==null?void 0:s.parts[0])==null?void 0:c.text)||"",model:e.model,provider:"gemini",timestamp:new Date().toISOString()}}async function z(t){try{return(await fetch("https://api.openai.com/v1/models",{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}})).ok}catch(e){return o.error("Failed to verify OpenAI API key",e),!1}}async function D(t){try{return(await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${t}`,{method:"GET"})).ok}catch(e){return o.error("Failed to verify Gemini API key",e),!1}}async function X(t,e){switch(t){case"openai":return await z(e);case"gemini":return await D(e);default:return!1}}async function x(t,e={}){var n;if(!chrome.ai)throw new Error("Chrome AI API not available");try{if(console.log("[MuseFlow] Using Chrome AI Summarizer API..."),chrome.ai.summarizer)return{text:(await chrome.ai.summarizer.summarize(t,{length:e.length||"medium",format:"paragraph"})).summary,model:"chrome-summarizer",provider:"chrome",timestamp:new Date().toISOString()};if(chrome.ai.languageModel){const a=await chrome.ai.languageModel.create({model:"gemini-pro"}),r=`Summarize the following text in ${e.length||"medium"} length:

${t}`,i=await a.prompt(r,{temperature:.3,maxTokens:e.length==="short"?150:e.length==="long"?500:300,topP:.9});return{text:i.response,model:"gemini-pro",provider:"chrome",timestamp:new Date().toISOString(),tokensUsed:(n=i.usage)==null?void 0:n.totalTokens}}throw new Error("No Chrome AI summarization APIs available")}catch(a){throw console.error("[MuseFlow] Chrome AI summarization failed:",a),a}}async function L(t,e={}){var n;if(!chrome.ai)throw new Error("Chrome AI API not available");try{if(console.log("[MuseFlow] Using Chrome AI Language Model API..."),chrome.ai.languageModel){const r=await(await chrome.ai.languageModel.create({model:e.model||"gemini-pro"})).prompt(t,{temperature:e.temperature||.7,maxTokens:e.maxTokens||500,topP:e.topP||.9});return{text:r.response,model:e.model||"gemini-pro",provider:"chrome",timestamp:new Date().toISOString(),tokensUsed:(n=r.usage)==null?void 0:n.totalTokens}}throw new Error("Chrome AI Language Model API not available")}catch(a){throw console.error("[MuseFlow] Chrome AI text generation failed:",a),a}}async function _(t,e,n){var a;if(!chrome.ai)throw new Error("Chrome AI API not available");try{if(console.log("[MuseFlow] Using Chrome AI for translation..."),chrome.ai.languageModel){const r=await chrome.ai.languageModel.create({model:"gemini-pro"}),i=`Translate the following text from ${n||"auto-detect"} to ${e}:

${t}`,s=await r.prompt(i,{temperature:.3,maxTokens:Math.min(t.length*2,1e3),topP:.9});return{text:s.response,model:"gemini-pro",provider:"chrome",timestamp:new Date().toISOString(),tokensUsed:(a=s.usage)==null?void 0:a.totalTokens}}throw new Error("Chrome AI Language Model API not available for translation")}catch(r){throw console.error("[MuseFlow] Chrome AI translation failed:",r),r}}const Y=Object.freeze(Object.defineProperty({__proto__:null,callChromeAI:v,callChromeAIGenerate:L,callChromeAISummarize:x,callChromeAITranslate:_,verifyGeminiKey:D,verifyKey:X,verifyOpenAIKey:z},Symbol.toStringTag,{value:"Module"}));class Z{constructor(){p(this,"stats",{totalEntries:0,hits:0,misses:0,hitRate:0,oldestEntry:0,newestEntry:0})}async generateHash(e,n,a={}){const r=`${n}:${e}:${JSON.stringify(a)}`,s=new TextEncoder().encode(r),c=await crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(c)).map(u=>u.toString(16).padStart(2,"0")).join("")}async getCacheEntry(e,n,a={}){try{if(!(await S()).features.enableCaching)return this.stats.misses++,this.updateHitRate(),null;const i=await this.generateHash(e,n,a),s=`cache_${i}`,l=(await chrome.storage.local.get([s]))[s];if(!l)return this.stats.misses++,this.updateHitRate(),o.debug("Cache miss",{action:n,inputHash:i}),null;const u=Date.now();return u>l.timestamp+l.ttl?(await this.removeCacheEntry(s),this.stats.misses++,this.updateHitRate(),o.debug("Cache entry expired",{action:n,inputHash:i,age:u-l.timestamp}),null):(this.stats.hits++,this.updateHitRate(),o.debug("Cache hit",{action:n,inputHash:i,age:u-l.timestamp}),l.response)}catch(r){return console.error("[MuseFlow] Cache error:",r),o.error("Failed to get cache entry",r,{action:n}),this.stats.misses++,this.updateHitRate(),null}}async saveToCache(e,n,a,r={}){try{const i=await S();if(!i.features.enableCaching)return;const s=await this.generateHash(n,e,r),c=`cache_${s}`,l={id:c,inputText:n,response:a,timestamp:Date.now(),ttl:i.limits.cacheTtl,action:e,inputHash:s};await chrome.storage.local.set({[c]:l}),this.stats.totalEntries++,this.updateStats(),o.debug("Response cached",{action:e,inputHash:s,responseLength:a.text.length}),await this.cleanupOldEntries()}catch(i){console.error("[MuseFlow] Cache save error:",i),o.error("Failed to save to cache",i,{action:e})}}async removeCacheEntry(e){try{await chrome.storage.local.remove([e]),this.stats.totalEntries=Math.max(0,this.stats.totalEntries-1),this.updateStats(),o.debug("Cache entry removed",{cacheKey:e})}catch(n){o.error("Failed to remove cache entry",n,{cacheKey:e})}}async clearCache(){try{const e=await chrome.storage.local.get(null),n=Object.keys(e).filter(a=>a.startsWith("cache_"));n.length>0&&await chrome.storage.local.remove(n),this.stats.totalEntries=0,this.stats.hits=0,this.stats.misses=0,this.stats.hitRate=0,this.updateStats(),o.info("Cache cleared",{entriesRemoved:n.length})}catch(e){o.error("Failed to clear cache",e)}}getStats(){return{...this.stats}}async getAllCacheEntries(){try{const e=await chrome.storage.local.get(null),n=[];for(const[a,r]of Object.entries(e))a.startsWith("cache_")&&r&&typeof r=="object"&&n.push(r);return n.sort((a,r)=>r.timestamp-a.timestamp)}catch(e){return o.error("Failed to get all cache entries",e),[]}}updateHitRate(){const e=this.stats.hits+this.stats.misses;this.stats.hitRate=e>0?this.stats.hits/e:0}async updateStats(){try{const e=await this.getAllCacheEntries();e.length>0?(this.stats.oldestEntry=Math.min(...e.map(n=>n.timestamp)),this.stats.newestEntry=Math.max(...e.map(n=>n.timestamp))):(this.stats.oldestEntry=0,this.stats.newestEntry=0)}catch(e){o.error("Failed to update cache stats",e)}}async cleanupOldEntries(){try{const e=await S(),n=await this.getAllCacheEntries();if(n.length<=e.limits.maxCacheEntries)return;n.sort((i,s)=>i.timestamp-s.timestamp);const a=n.slice(0,n.length-e.limits.maxCacheEntries),r=a.map(i=>i.id);await chrome.storage.local.remove(r),this.stats.totalEntries=n.length-a.length,this.updateStats(),o.info("Cache cleanup completed",{removed:a.length,remaining:this.stats.totalEntries})}catch(e){o.error("Failed to cleanup old cache entries",e)}}}const C=new Z;async function I(t,e,n={}){return C.getCacheEntry(t,e,n)}async function b(t,e,n,a={}){return C.saveToCache(t,e,n,a)}async function Q(){return C.clearCache()}const q=Object.freeze(Object.defineProperty({__proto__:null,cacheManager:C,clearCache:Q,getCachedResponse:I,saveToCache:b},Symbol.toStringTag,{value:"Module"}));async function ee(t,e={}){const n=Date.now();try{o.info("Starting summarization",{textLength:t.length,options:Object.keys(e)});const a=await I(t,"summarize",e);if(a)return o.debug("Using cached summarization response"),{summary:a.text,metadata:{originalLength:t.length,summaryLength:a.text.length,compressionRatio:a.text.length/t.length,processingTime:Date.now()-n}};const i={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=`${t.substring(0,5e3)}...`);const c={prompt:te(t,i),maxTokens:ae(i.summaryLength||"medium"),temperature:.3};let l;try{console.log("[MuseFlow] Attempting Chrome AI summarization..."),l=await x(t,{length:i.summaryLength||"medium"}),console.log("[MuseFlow] Chrome AI summarization successful")}catch{console.log("[MuseFlow] Chrome AI summarization failed, falling back to general AI..."),l=await v(c)}const u=re(l.text,i),g=Date.now()-n,m={...u,metadata:{originalLength:t.length,summaryLength:u.summary.length,compressionRatio:u.summary.length/t.length,processingTime:g}};return await b("summarize",t,l,e),o.info("Summarization completed",{originalLength:m.metadata.originalLength,summaryLength:m.metadata.summaryLength,compressionRatio:m.metadata.compressionRatio,processingTime:m.metadata.processingTime}),m}catch(a){throw o.error("Summarization failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function te(t,e){const n=ne(e.summaryLength||"medium"),a=e.includeKeyPoints?" Also provide key points as a bulleted list.":"",r=e.focusAreas&&e.focusAreas.length>0?` Focus specifically on: ${e.focusAreas.join(", ")}.`:"";return`Summarize the following text clearly and concisely.

INSTRUCTIONS:
${n}${a}${r}
Focus on the main points and key information while maintaining accuracy and clarity.
Remove redundant information and present the core message effectively.

TEXT TO SUMMARIZE:
${t}

Please provide a well-structured summary that captures the essential information.`}function ne(t){switch(t){case"short":return"Provide a concise summary (1-2 sentences).";case"long":return"Provide a comprehensive summary with key details and context.";case"medium":default:return"Provide a balanced summary (3-5 sentences)."}}function ae(t){switch(t){case"short":return 150;case"long":return 500;case"medium":default:return 300}}function re(t,e){const n=t.trim();if(!n)throw new Error("Empty response from AI service");const a={summary:n};if(e.includeKeyPoints){const r=se(n);r.length>0&&(a.keyPoints=r)}return a.confidence=ie(n),a}function se(t){const e=[],n=t.split(`
`);for(const a of n){const r=a.trim();if(r.startsWith("•")||r.startsWith("-")||r.startsWith("*")||r.startsWith("◦")||/^\d+\./.test(r)){const i=r.replace(/^[•\-*◦]|\d+\./,"").trim();i.length>0&&e.push(i)}}return e}function ie(t){let e=.5;t.length>=50&&t.length<=1e3&&(e+=.2);const n=t.split(/[.!?]+/).filter(a=>a.trim().length>0);return n.length>=2&&n.length<=10&&(e+=.2),(t.includes("The")||t.includes("This")||t.includes("It"))&&(e+=.1),Math.min(1,e)}async function oe(t,e={}){const n=Date.now();try{o.info("Starting text rewriting",{textLength:t.length,options:Object.keys(e)});const a=await I(t,"rewrite",e);if(a)return o.debug("Using cached rewrite response"),{rewrittenText:a.text,originalText:t,changes:F(t,a.text),metadata:{originalLength:t.length,rewrittenLength:a.text.length,processingTime:Date.now()-n}};const i={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=`${t.substring(0,5e3)}...`);const s=ce(t,i),c={prompt:s,maxTokens:Math.min(t.length*1.5,2e3),temperature:.4};let l;try{console.log("[MuseFlow] Attempting Chrome AI text generation for rewrite..."),l=await L(s,{temperature:.7,maxTokens:Math.min(t.length*2,1e3),topP:.9,model:"gemini-pro"}),console.log("[MuseFlow] Chrome AI rewrite successful")}catch{console.log("[MuseFlow] Chrome AI rewrite failed, falling back to general AI..."),l=await v(c)}const u=ge(l.text),g=F(t,u),m=Date.now()-n,h={rewrittenText:u,originalText:t,changes:g,confidence:pe(t,u,i),metadata:{originalLength:t.length,rewrittenLength:u.length,processingTime:m}};return await b("rewrite",t,l,e),o.info("Text rewriting completed",{originalLength:h.metadata.originalLength,rewrittenLength:h.metadata.rewrittenLength,wordCountChange:h.changes.wordCountChange,processingTime:h.metadata.processingTime}),h}catch(a){throw o.error("Text rewriting failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function ce(t,e){const n=le(e.tone||"professional"),a=ue(e.style),r=me(e.audience),i=e.improvements&&e.improvements.length>0?` Focus on these specific improvements: ${e.improvements.join(", ")}.`:"";return`Rewrite the following text to improve clarity, flow, and readability while preserving the original meaning and intent.

INSTRUCTIONS:
${n}${a}${r}${i}
Maintain the core message and key information while enhancing the writing quality.

ORIGINAL TEXT:
${t}

Please provide a rewritten version that is clearer, more engaging, and better structured.`}function le(t){switch(t){case"formal":return"Use a formal, professional tone with sophisticated vocabulary.";case"casual":return"Use a casual, conversational tone that is friendly and approachable.";case"professional":return"Use a professional, business-appropriate tone that is clear and authoritative.";case"creative":return"Use a creative, engaging tone with vivid language and compelling narrative.";case"academic":return"Use an academic tone with precise terminology and scholarly language.";case"conversational":return"Use a conversational tone that feels natural and easy to read.";default:return"Use a clear, polished tone."}}function ue(t){if(!t)return"";const e=[];return t.activeVoice&&e.push("Use active voice whenever possible."),t.simplify&&e.push("Simplify complex sentences and use clear, straightforward language."),t.descriptive&&e.push("Add descriptive language and vivid details where appropriate."),t.clarity&&e.push("Prioritize clarity and eliminate any ambiguity."),e.length>0?` ${e.join(" ")}`:""}function me(t){if(!t)return"";switch(t){case"technical":return" Write for a technical audience familiar with specialized terminology.";case"academic":return" Write for an academic audience with scholarly expectations.";case"business":return" Write for a business audience focused on results and professionalism.";case"casual":return" Write for a casual audience that prefers simple, friendly language.";case"general":default:return" Write for a general audience that values clarity and accessibility."}}function ge(t){const e=t.trim();if(!e)throw new Error("Empty response from AI service");const n=e.split(`
`);let a=0;for(let r=0;r<n.length;r++){const i=n[r].trim();if(i&&!i.toLowerCase().includes("rewritten")&&!i.toLowerCase().includes("version")){a=r;break}}return n.slice(a).join(`
`).trim()}function F(t,e){const n=t.split(/\s+/).length,a=e.split(/\s+/).length,r=t.split(/[.!?]+/).filter(s=>s.trim().length>0).length,i=e.split(/[.!?]+/).filter(s=>s.trim().length>0).length;return{wordCountChange:a-n,sentenceCountChange:i-r,readabilityScore:he(e)}}function he(t){const e=t.split(/[.!?]+/).filter(i=>i.trim().length>0).length,n=t.split(/\s+/).length,a=t.split(/\s+/).reduce((i,s)=>i+de(s),0);if(e===0||n===0)return 0;const r=206.835-1.015*(n/e)-84.6*(a/n);return Math.max(0,Math.min(100,r))}function de(t){const e=t.toLowerCase().replace(/[^a-z]/g,"");if(e.length===0)return 0;const n="aeiouy";let a=0,r=!1;for(let i=0;i<e.length;i++){const s=n.includes(e[i]);s&&!r&&a++,r=s}return e.endsWith("e")&&a>1&&a--,Math.max(1,a)}function pe(t,e,n){let a=.5;const r=e.length/t.length;r>=.7&&r<=1.5&&(a+=.2);const i=t.split(/[.!?]+/).filter(c=>c.trim().length>0).length,s=e.split(/[.!?]+/).filter(c=>c.trim().length>0).length;return s>0&&s<=i*1.5&&(a+=.2),n.tone&&fe(n.tone).filter(u=>e.toLowerCase().includes(u.toLowerCase())).length>0&&(a+=.1),Math.min(1,a)}function fe(t){switch(t){case"formal":return["therefore","furthermore","consequently","moreover"];case"casual":return["actually","really","pretty","kind of"];case"professional":return["recommend","suggest","propose","indicate"];case"creative":return["imagine","picture","envision","visualize"];default:return[]}}async function we(t,e={}){const n=Date.now();try{o.info("Starting ideation",{textLength:t.length,options:Object.keys(e)});const a=await I(t,"ideate",e);if(a){o.debug("Using cached ideation response");const d=O(a.text);return{ideas:d,context:{originalText:t,domain:e.domain,focusAreas:e.focusAreas,constraints:e.constraints},metadata:{ideaCount:d.length,processingTime:Date.now()-n}}}const i={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=`${t.substring(0,5e3)}...`);const s=ye(t,i),c={prompt:s,maxTokens:1500,temperature:.8};let l;try{console.log("[MuseFlow] Attempting Chrome AI text generation for ideation..."),l=await L(s,{temperature:.8,maxTokens:Math.min(t.length*3,1500),topP:.9,model:"gemini-pro"}),console.log("[MuseFlow] Chrome AI ideation successful")}catch{console.log("[MuseFlow] Chrome AI ideation failed, falling back to general AI..."),l=await v(c)}const u=O(l.text),g=Date.now()-n,m=Ie(u),h={ideas:u,context:{originalText:t,domain:e.domain,focusAreas:e.focusAreas,constraints:e.constraints},metadata:{ideaCount:u.length,processingTime:g,creativityScore:m}};return await b("ideate",t,l,e),o.info("Ideation completed",{ideaCount:h.metadata.ideaCount,creativityScore:h.metadata.creativityScore,processingTime:h.metadata.processingTime}),h}catch(a){throw o.error("Ideation failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function ye(t,e){const n=e.ideaCount||5,a=ve(e.ideaType||"mixed"),r=e.domain?` Focus on ideas relevant to the ${e.domain} domain.`:"",i=e.focusAreas&&e.focusAreas.length>0?` Pay special attention to: ${e.focusAreas.join(", ")}.`:"",s=e.constraints&&e.constraints.length>0?` Consider these constraints: ${e.constraints.join(", ")}.`:"",c=e.audience?` Tailor ideas for a ${e.audience} audience.`:"",l=e.timeframe?` Focus on ${e.timeframe}-term implementation ideas.`:"";return`Generate creative, innovative ideas based on the following text. Think outside the box and provide practical, actionable insights.

INSTRUCTIONS:
Generate ${n} distinct ideas.${a}${r}${i}${s}${c}${l}
Each idea should be specific, actionable, and build upon the content provided.

SOURCE TEXT:
${t}

For each idea, provide:
1. A clear, compelling title
2. A detailed description explaining the concept
3. Implementation steps or approach
4. Potential benefits
5. Potential challenges
6. Effort level (low/medium/high)
7. Impact level (low/medium/high)

Please format your response clearly with numbered ideas and organized sections.`}function ve(t){switch(t){case"creative":return" Focus on highly creative, innovative, and out-of-the-box ideas.";case"practical":return" Focus on practical, implementable ideas with clear benefits.";case"strategic":return" Focus on strategic, long-term thinking and planning ideas.";case"innovative":return" Focus on breakthrough innovations and novel approaches.";case"mixed":default:return" Provide a mix of creative, practical, and strategic ideas."}}function O(t){const e=[],n=t.split(`
`);let a={},r="";for(let i=0;i<n.length;i++){const s=n[i].trim();if(s){if(/^\d+\./.test(s)||/^idea\s+\d+/i.test(s)){a.title&&e.push(a),a={title:s.replace(/^\d+\.\s*/,"").replace(/^idea\s+\d+:\s*/i,"")},r="";continue}if(s.toLowerCase().includes("description")||s.toLowerCase().includes("explanation")){r="description";continue}else if(s.toLowerCase().includes("implementation")||s.toLowerCase().includes("steps")){r="implementation";continue}else if(s.toLowerCase().includes("benefits")||s.toLowerCase().includes("advantages")){r="benefits";continue}else if(s.toLowerCase().includes("challenges")||s.toLowerCase().includes("difficulties")){r="challenges";continue}else if(s.toLowerCase().includes("effort")||s.toLowerCase().includes("difficulty")){r="effort";continue}else if(s.toLowerCase().includes("impact")||s.toLowerCase().includes("effect")){r="impact";continue}if(r==="description")a.description=`${a.description||""} ${s}`;else if(r==="implementation")a.implementation||(a.implementation=[]),a.implementation.push(s.replace(/^[-•*]\s*/,""));else if(r==="benefits")a.benefits||(a.benefits=[]),a.benefits.push(s.replace(/^[-•*]\s*/,""));else if(r==="challenges")a.challenges||(a.challenges=[]),a.challenges.push(s.replace(/^[-•*]\s*/,""));else if(r==="effort"){const c=s.toLowerCase();c.includes("low")?a.effortLevel="low":c.includes("high")?a.effortLevel="high":a.effortLevel="medium"}else if(r==="impact"){const c=s.toLowerCase();c.includes("low")?a.impactLevel="low":c.includes("high")?a.impactLevel="high":a.impactLevel="medium"}}}return a.title&&e.push(a),e.map(i=>{var s,c;return{...i,title:((s=i.title)==null?void 0:s.trim())||"Untitled Idea",description:((c=i.description)==null?void 0:c.trim())||"No description provided",implementation:i.implementation||[],benefits:i.benefits||[],challenges:i.challenges||[],effortLevel:i.effortLevel||"medium",impactLevel:i.impactLevel||"medium"}})}function Ie(t){if(t.length===0)return 0;let e=0;const n=t.length;for(const a of t){let r=.2;a.title&&a.title.length>10&&(r+=.1),a.description&&a.description.length>50&&(r+=.2),a.implementation&&a.implementation.length>0&&(r+=.2),a.benefits&&a.benefits.length>0&&(r+=.1),a.challenges&&a.challenges.length>0&&(r+=.1),a.effortLevel&&a.impactLevel&&(r+=.1),e+=r}return Math.min(1,e/n)}async function be(t,e={}){const n=Date.now();try{o.info("Starting translation",{textLength:t.length,options:Object.keys(e)});const r={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=`${t.substring(0,5e3)}...`);const i=r.sourceLanguage||await Te(t),s=r.targetLanguage||"English",c=await I(t,"translate",r);if(c)return o.debug("Using cached translation response"),{translatedText:c.text,originalText:t,sourceLanguage:i,targetLanguage:s,metadata:{originalLength:t.length,translatedLength:c.text.length,processingTime:Date.now()-n}};const u={prompt:Se(t,i,s,r),maxTokens:Math.min(t.length*2,3e3),temperature:.3};let g;try{console.log("[MuseFlow] Attempting Chrome AI translation..."),g=await _(t,r.targetLanguage||"English",r.sourceLanguage),console.log("[MuseFlow] Chrome AI translation successful")}catch{console.log("[MuseFlow] Chrome AI translation failed, falling back to general AI..."),g=await v(u)}const m=Ee(g.text),h=Date.now()-n,d=Me(t,m,i,s),f={translatedText:m,originalText:t,sourceLanguage:i,targetLanguage:s,confidence:Le(t,m,i,s),metadata:{originalLength:t.length,translatedLength:m.length,processingTime:h,qualityScore:d}};return await b("translate",t,g,r),o.info("Translation completed",{sourceLanguage:f.sourceLanguage,targetLanguage:f.targetLanguage,originalLength:f.metadata.originalLength,translatedLength:f.metadata.translatedLength,processingTime:f.metadata.processingTime}),f}catch(a){throw o.error("Translation failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function Se(t,e,n,a){const r=Ae(a.style),i=Ce(a.domain),s=a.culturalAdaptation?" Adapt cultural references and idioms appropriately for the target language and culture.":"",c=a.preserveFormatting?" Preserve all formatting, including line breaks, punctuation, and special characters.":"";return`Translate the following text from ${e} to ${n}.

INSTRUCTIONS:
${r}${i}${s}${c}
Maintain the original meaning, tone, and context while ensuring the translation reads naturally in ${n}.
Preserve any technical terms, proper nouns, or specialized vocabulary appropriately.

TEXT TO TRANSLATE:
${t}

Please provide an accurate, natural-sounding translation in ${n}.`}function Ae(t){switch(t){case"formal":return"Use formal language and register appropriate for official or academic contexts.";case"informal":return"Use informal, conversational language that sounds natural and casual.";case"technical":return"Use precise technical terminology and maintain technical accuracy.";case"literary":return"Preserve literary style, metaphors, and artistic expression.";case"conversational":return"Use conversational tone that feels natural and easy to read.";default:return"Use clear, natural language appropriate for general communication."}}function Ce(t){switch(t){case"business":return"Use business-appropriate language and terminology.";case"technical":return"Maintain technical accuracy and use precise technical terminology.";case"medical":return"Use accurate medical terminology and maintain clinical precision.";case"legal":return"Use precise legal terminology and maintain legal accuracy.";case"academic":return"Use scholarly language and maintain academic rigor.";default:return""}}async function Te(t){const e={English:/^(the|and|or|but|in|on|at|to|for|of|with|by)\s/i,Spanish:/^(el|la|los|las|un|una|de|del|en|con|por|para)\s/i,French:/^(le|la|les|un|une|de|du|des|en|avec|pour|par)\s/i,German:/^(der|die|das|ein|eine|und|oder|aber|in|auf|mit|für)\s/i,Italian:/^(il|la|lo|gli|le|un|una|di|del|della|in|con|per)\s/i,Portuguese:/^(o|a|os|as|um|uma|de|do|da|em|com|para)\s/i,Russian:/^[а-яё]/i,Chinese:/[\u4e00-\u9fff]/,Japanese:/[\u3040-\u309f\u30a0-\u30ff]/,Korean:/[\uac00-\ud7af]/,Arabic:/[\u0600-\u06ff]/};for(const[n,a]of Object.entries(e))if(a.test(t))return n;return"English"}function Ee(t){const e=t.trim();if(!e)throw new Error("Empty response from AI service");const n=e.split(`
`);let a=0;for(let r=0;r<n.length;r++){const i=n[r].trim();if(i&&!i.toLowerCase().includes("translation")&&!i.toLowerCase().includes("translated")){a=r;break}}return n.slice(a).join(`
`).trim()}function Le(t,e,n,a){let r=.5;const i=e.length/t.length;i>=.5&&i<=2&&(r+=.2);const s=t.split(/[.!?]+/).filter(m=>m.trim().length>0).length,c=e.split(/[.!?]+/).filter(m=>m.trim().length>0).length;Math.abs(s-c)<=1&&(r+=.2);const l=t.split(/\s+/).length,g=e.split(/\s+/).length/l;return g>=.7&&g<=1.5&&(r+=.1),Math.min(1,r)}function Me(t,e,n,a){let r=.5;e.length>0&&(r+=.2),a==="English"&&/[a-zA-Z]/.test(e)&&(r+=.1);const i=t.split(/\n\s*\n/).length,s=e.split(/\n\s*\n/).length;Math.abs(i-s)<=1&&(r+=.1);const c=(t.match(/[.!?]/g)||[]).length,l=(e.match(/[.!?]/g)||[]).length;return Math.abs(c-l)<=2&&(r+=.1),Math.min(1,r)}async function Pe(t,e,n){var i;const a=Date.now(),r=t.requestId||_e();try{if(console.log("[MuseFlow] Message received:",{action:t.action,requestId:r,source:t.source,tabId:t.tabId,senderId:(i=e.tab)==null?void 0:i.id}),!t.action)throw new Error("Action is required");let s;const c={processingTime:Date.now()-a,timestamp:new Date().toISOString(),action:t.action};switch(t.action){case"ping":s=await ke();break;case"summarize":s=await Fe(t.text,t.options);break;case"rewrite":s=await Oe(t.text,t.options);break;case"ideate":s=await Re(t.text,t.options);break;case"translate":s=await $e(t.text,t.options);break;case"verifyKey":s=await De(t.options);break;case"getSettings":s=await Ue();break;case"updateSettings":s=await ze(t.options);break;case"clearCache":s=await xe();break;default:throw new Error(`Unknown action: ${t.action}`)}const l={success:!0,data:s,requestId:r,metadata:c};return console.log("[MuseFlow] Router executed action:",t.action),console.log("[MuseFlow] Response sent:",l),n(l),!0}catch(s){const c=Date.now()-a;console.error("[MuseFlow] Message processing failed:",s);const l={success:!1,error:s instanceof Error?s.message:"Unknown error occurred",requestId:r,metadata:{processingTime:c,timestamp:new Date().toISOString(),action:t.action}};return s instanceof Error&&(s.message.includes("INSUFFICIENT_CONTEXT")?l.error="INSUFFICIENT_CONTEXT: Please provide at least 10 characters of text":s.message.includes("Chrome AI API not available")?l.error="AI service unavailable: Chrome AI API not accessible":s.message.includes("No AI provider available")&&(l.error="AI service unavailable: No AI providers configured")),console.log("[MuseFlow] Error response sent:",l),n(l),!0}}async function ke(){return{status:"pong",timestamp:new Date().toISOString()}}async function Fe(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for summarization");return await ee(t,e)}async function Oe(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for rewriting");return await oe(t,e)}async function Re(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for ideation");return await we(t,e)}async function $e(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for translation");return await be(t,e)}async function Ue(){const{settingsManager:t}=await A(async()=>{const{settingsManager:e}=await Promise.resolve().then(()=>U);return{settingsManager:e}},void 0);return t.getSettings()}async function ze(t){const{settingsManager:e}=await A(async()=>{const{settingsManager:n}=await Promise.resolve().then(()=>U);return{settingsManager:n}},void 0);return t.user&&await e.updateUserSettings(t.user),t.providers&&await e.updateProviderSettings(t.providers),e.getSettings()}async function De(t){const{verifyKey:e}=await A(async()=>{const{verifyKey:a}=await Promise.resolve().then(()=>Y);return{verifyKey:a}},void 0);if(!t.provider||!t.apiKey)throw new Error("Provider and API key are required");return{valid:await e(t.provider,t.apiKey),provider:t.provider}}async function xe(){const{clearCache:t}=await A(async()=>{const{clearCache:e}=await Promise.resolve().then(()=>q);return{clearCache:e}},void 0);return await t(),{message:"Cache cleared successfully"}}function _e(){return`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async function je(){try{await o.initializeLogging(),console.log("[MuseFlow] Backend initialized successfully")}catch(t){console.error("Failed to initialize MuseFlow backend:",t)}}je();chrome.runtime.onInstalled.addListener(t=>{console.log("[MuseFlow] Extension installed/updated:",t.reason),chrome.contextMenus.create({id:"museflow-summarize",title:"Summarize with MuseFlow",contexts:["selection"]}),chrome.contextMenus.create({id:"museflow-rewrite",title:"Rewrite with MuseFlow",contexts:["selection"]}),chrome.contextMenus.create({id:"museflow-ideate",title:"Ideate with MuseFlow",contexts:["selection"]}),chrome.contextMenus.create({id:"museflow-translate",title:"Translate with MuseFlow",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener((t,e)=>{var a;if(!t.selectionText||!(e!=null&&e.id))return;const n=(a=t.menuItemId)==null?void 0:a.replace("museflow-","");n&&["summarize","rewrite","ideate","translate"].includes(n)&&chrome.tabs.sendMessage(e.id,{type:"TRIGGER_ACTION",action:n,text:t.selectionText,source:"contextMenu"}).catch(r=>{console.error("[MuseFlow] Failed to send message to content script:",r)})});chrome.runtime.onMessage.addListener((t,e,n)=>(console.log("[MuseFlow] Message received:",t),Pe(t,e,n).catch(a=>{console.error("[MuseFlow] Error handling message:",a),n({success:!1,error:a.message||"Unknown error occurred"})}),!0));
