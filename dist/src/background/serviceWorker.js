var _=Object.defineProperty;var j=(t,e,n)=>e in t?_(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var m=(t,e,n)=>j(t,typeof e!="symbol"?e+"":e,n);const N="modulepreload",W=function(t){return"/"+t},O={},T=function(e,n,a){let i=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),c=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));i=Promise.allSettled(n.map(l=>{if(l=W(l),l in O)return;O[l]=!0;const u=l.endsWith(".css"),h=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const g=document.createElement("link");if(g.rel=u?"stylesheet":N,u||(g.as="script"),g.crossOrigin="",g.href=l,c&&g.setAttribute("nonce",c),document.head.appendChild(g),u)return new Promise((d,p)=>{g.addEventListener("load",d),g.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${l}`)))})}))}function s(r){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=r,window.dispatchEvent(c),!c.defaultPrevented)throw r}return i.then(r=>{for(const c of r||[])c.status==="rejected"&&s(c.reason);return e().catch(s)})};var C=(t=>(t[t.DEBUG=0]="DEBUG",t[t.INFO=1]="INFO",t[t.WARN=2]="WARN",t[t.ERROR=3]="ERROR",t))(C||{});class K{constructor(){m(this,"currentLevel",1);m(this,"logs",[]);m(this,"maxLogs",1e3)}setLevel(e){this.currentLevel=e}getLevel(){return this.currentLevel}debug(e,n){this.log(0,e,n)}info(e,n){this.log(1,e,n)}warn(e,n){this.log(2,e,n)}error(e,n,a){this.log(3,e,{...a,error:n})}log(e,n,a){if(e<this.currentLevel)return;const i={timestamp:new Date().toISOString(),level:e,message:n,context:a};this.logs.push(i),this.logs.length>this.maxLogs&&this.logs.shift();const s=this.formatMessage(i);switch(e){case 0:console.debug(s,a);break;case 1:console.info(s,a);break;case 2:console.warn(s,a);break;case 3:console.error(s,a);break}e>=2&&this.storeInChromeStorage(i)}formatMessage(e){const n=C[e.level];return`[${new Date(e.timestamp).toLocaleTimeString()}] [${n}] ${e.message}`}async storeInChromeStorage(e){try{const a=(await chrome.storage.local.get(["logs"])).logs||[];a.push(e),a.length>50&&a.splice(0,a.length-50),await chrome.storage.local.set({logs:a})}catch(n){console.error("Failed to store log in Chrome storage:",n)}}getLogs(e=100){return this.logs.slice(-e)}clearLogs(){this.logs=[]}async getStoredLogs(){try{return(await chrome.storage.local.get(["logs"])).logs||[]}catch(e){return console.error("Failed to get stored logs:",e),[]}}async clearStoredLogs(){try{await chrome.storage.local.remove(["logs"])}catch(e){console.error("Failed to clear stored logs:",e)}}}const o=new K;async function G(){try{const t=await chrome.storage.sync.get(["logLevel"]);t.logLevel!==void 0&&o.setLevel(t.logLevel),o.info("Logging initialized",{level:C[o.getLevel()],timestamp:new Date().toISOString()})}catch(t){console.error("Failed to initialize logging:",t)}}const E={defaultLanguage:"English",defaultTone:"professional",defaultSummaryLength:"medium",preferredProvider:"chrome",autoCache:!0,showDebugInfo:!1,keyboardShortcuts:!0,popupPosition:"top",theme:"auto",animations:!0,soundEffects:!1,autoExpandPopup:!1,contextWindowSize:1e3},A={requestTimeout:3e4,maxRetries:3,rateLimit:{requestsPerMinute:60,requestsPerHour:1e3}},w={user:E,providers:A,lastUpdated:Date.now(),version:"1.0.0"};class H{constructor(){m(this,"settings",w);m(this,"isInitialized",!1)}async initialize(){try{const e=await chrome.storage.sync.get(["appSettings"]);e.appSettings?(this.settings={...w,...e.appSettings},o.debug("Settings loaded from storage",{version:this.settings.version,lastUpdated:new Date(this.settings.lastUpdated).toISOString()})):(await this.saveSettings(),o.debug("Default settings initialized")),this.isInitialized=!0}catch(e){o.error("Failed to initialize settings",e),this.settings=w,this.isInitialized=!0}}getSettings(){return{...this.settings}}getUserSettings(){return{...this.settings.user}}getProviderSettings(){return{...this.settings.providers}}async updateUserSettings(e){try{this.settings.user={...this.settings.user,...e},this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.info("User settings updated",{updates:Object.keys(e),timestamp:new Date(this.settings.lastUpdated).toISOString()})}catch(n){throw o.error("Failed to update user settings",n,{updates:e}),n}}async updateProviderSettings(e){try{this.settings.providers={...this.settings.providers,...e},this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.info("Provider settings updated",{updates:Object.keys(e),timestamp:new Date(this.settings.lastUpdated).toISOString()})}catch(n){throw o.error("Failed to update provider settings",n,{updates:e}),n}}getDefaultPromptOptions(){return{targetLanguage:this.settings.user.defaultLanguage,tone:this.settings.user.defaultTone,summaryLength:this.settings.user.defaultSummaryLength}}async resetSettings(){try{this.settings={...w},await this.saveSettings(),o.info("Settings reset to defaults")}catch(e){throw o.error("Failed to reset settings",e),e}}exportSettings(){return JSON.stringify(this.settings,null,2)}async importSettings(e){try{const n=JSON.parse(e);if(!n.user||!n.providers)throw new Error("Invalid settings format");this.settings={user:{...E,...n.user},providers:{...A,...n.providers},lastUpdated:Date.now(),version:n.version||w.version},await this.saveSettings(),o.info("Settings imported successfully",{version:this.settings.version})}catch(n){throw o.error("Failed to import settings",n),n}}async saveSettings(){try{await chrome.storage.sync.set({appSettings:this.settings}),o.debug("Settings saved to storage")}catch(e){throw o.error("Failed to save settings to storage",e),e}}isReady(){return this.isInitialized}getSettingValue(e){const n=e.split(".");let a=this.settings;for(const i of n)if(a&&typeof a=="object"&&i in a)a=a[i];else return;return a}async setSettingValue(e,n){const a=e.split("."),i=a.pop();let s=this.settings;for(const r of a)(!s[r]||typeof s[r]!="object")&&(s[r]={}),s=s[r];s[i]=n,this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.debug("Setting value updated",{path:e,value:n})}}const P=new H;async function k(){return P.initialize()}function y(){return P.getDefaultPromptOptions()}const F=Object.freeze(Object.defineProperty({__proto__:null,defaultAppSettings:w,defaultProviderSettings:A,defaultUserSettings:E,getDefaultPromptOptions:y,initializeSettings:k,settingsManager:P},Symbol.toStringTag,{value:"Module"}));var R={};const M={ai:{provider:"chrome",openai:{apiKey:R.OPENAI_API_KEY||"",model:"gpt-3.5-turbo",baseUrl:"https://api.openai.com/v1"},chrome:{model:"gemini-pro"},gemini:{apiKey:R.GEMINI_API_KEY||"",model:"gemini-pro"}},limits:{maxTextLength:5e3,maxCacheEntries:100,cacheTtl:24*60*60*1e3},features:{enableCaching:!0,enableLogging:!0,enableFallback:!0}};async function I(){try{const t=await chrome.storage.sync.get(["config"]);return{...M,...t.config}}catch(t){return console.warn("Failed to load config from storage, using defaults:",t),M}}async function v(t){const e=await I();try{if(e.ai.provider==="chrome"&&chrome.ai){o.debug("Attempting Chrome AI API call",{model:e.ai.chrome.model});const n=await V(t,e.ai.chrome.model);return o.info("Chrome AI API call successful",{provider:"chrome",model:e.ai.chrome.model,responseLength:n.text.length}),n}if(e.features.enableFallback&&e.ai.openai.apiKey){o.debug("Falling back to OpenAI API",{model:e.ai.openai.model});const n=await B(t,e.ai.openai);return o.info("OpenAI API call successful",{provider:"openai",model:e.ai.openai.model,responseLength:n.text.length}),n}if(e.features.enableFallback&&e.ai.gemini.apiKey){o.debug("Falling back to Gemini API",{model:e.ai.gemini.model});const n=await J(t,e.ai.gemini);return o.info("Gemini API call successful",{provider:"gemini",model:e.ai.gemini.model,responseLength:n.text.length}),n}throw new Error("No AI provider available")}catch(n){throw o.error("AI API call failed",n,{provider:e.ai.provider,request:{promptLength:t.prompt.length}}),n}}async function V(t,e){if(!chrome.ai)throw new Error("Chrome AI API not available");try{if(chrome.ai.languageModel)return{text:(await chrome.ai.languageModel.generateText({prompt:t.prompt,maxTokens:t.maxTokens||1e3,temperature:t.temperature||.7})).text,model:e,provider:"chrome",timestamp:new Date().toISOString()};if(chrome.ai.summarizer)return{text:(await chrome.ai.summarizer.summarize({text:t.prompt,maxLength:t.maxTokens||1e3})).summary,model:e,provider:"chrome",timestamp:new Date().toISOString()};throw new Error("No Chrome AI APIs available")}catch(n){throw new Error(`Chrome AI API call failed: ${n}`)}}async function B(t,e){var i,s,r,c;const n=await fetch(`${e.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.model,messages:[{role:"user",content:t.prompt}],max_tokens:t.maxTokens||1e3,temperature:t.temperature||.7})});if(!n.ok){const l=await n.json().catch(()=>({}));throw new Error(`OpenAI API error: ${n.status} ${((i=l.error)==null?void 0:i.message)||n.statusText}`)}const a=await n.json();return{text:((r=(s=a.choices[0])==null?void 0:s.message)==null?void 0:r.content)||"",model:e.model,provider:"openai",timestamp:new Date().toISOString(),tokensUsed:(c=a.usage)==null?void 0:c.total_tokens}}async function J(t,e){var i,s,r,c;const n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${e.model}:generateContent?key=${e.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:t.prompt}]}],generationConfig:{temperature:t.temperature||.7,maxOutputTokens:t.maxTokens||1e3}})});if(!n.ok){const l=await n.json().catch(()=>({}));throw new Error(`Gemini API error: ${n.status} ${((i=l.error)==null?void 0:i.message)||n.statusText}`)}return{text:((c=(r=(s=(await n.json()).candidates[0])==null?void 0:s.content)==null?void 0:r.parts[0])==null?void 0:c.text)||"",model:e.model,provider:"gemini",timestamp:new Date().toISOString()}}async function D(t){try{return(await fetch("https://api.openai.com/v1/models",{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}})).ok}catch(e){return o.error("Failed to verify OpenAI API key",e),!1}}async function z(t){try{return(await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${t}`,{method:"GET"})).ok}catch(e){return o.error("Failed to verify Gemini API key",e),!1}}async function X(t,e){switch(t){case"openai":return await D(e);case"gemini":return await z(e);default:return!1}}const Y=Object.freeze(Object.defineProperty({__proto__:null,callChromeAI:v,verifyGeminiKey:z,verifyKey:X,verifyOpenAIKey:D},Symbol.toStringTag,{value:"Module"}));class Z{constructor(){m(this,"stats",{totalEntries:0,hits:0,misses:0,hitRate:0,oldestEntry:0,newestEntry:0})}async generateHash(e,n,a={}){const i=`${n}:${e}:${JSON.stringify(a)}`,r=new TextEncoder().encode(i),c=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(c)).map(u=>u.toString(16).padStart(2,"0")).join("")}async getCacheEntry(e,n,a={}){try{if(!(await I()).features.enableCaching)return this.stats.misses++,this.updateHitRate(),null;const s=await this.generateHash(e,n,a),r=`cache_${s}`,l=(await chrome.storage.local.get([r]))[r];if(!l)return this.stats.misses++,this.updateHitRate(),o.debug("Cache miss",{action:n,inputHash:s}),null;const u=Date.now();return u>l.timestamp+l.ttl?(await this.removeCacheEntry(r),this.stats.misses++,this.updateHitRate(),o.debug("Cache entry expired",{action:n,inputHash:s,age:u-l.timestamp}),null):(this.stats.hits++,this.updateHitRate(),o.debug("Cache hit",{action:n,inputHash:s,age:u-l.timestamp}),l.response)}catch(i){return o.error("Failed to get cache entry",i,{action:n}),this.stats.misses++,this.updateHitRate(),null}}async saveToCache(e,n,a,i={}){try{const s=await I();if(!s.features.enableCaching)return;const r=await this.generateHash(n,e,i),c=`cache_${r}`,l={id:c,inputText:n,response:a,timestamp:Date.now(),ttl:s.limits.cacheTtl,action:e,inputHash:r};await chrome.storage.local.set({[c]:l}),this.stats.totalEntries++,this.updateStats(),o.debug("Response cached",{action:e,inputHash:r,responseLength:a.text.length}),await this.cleanupOldEntries()}catch(s){o.error("Failed to save to cache",s,{action:e})}}async removeCacheEntry(e){try{await chrome.storage.local.remove([e]),this.stats.totalEntries=Math.max(0,this.stats.totalEntries-1),this.updateStats(),o.debug("Cache entry removed",{cacheKey:e})}catch(n){o.error("Failed to remove cache entry",n,{cacheKey:e})}}async clearCache(){try{const e=await chrome.storage.local.get(null),n=Object.keys(e).filter(a=>a.startsWith("cache_"));n.length>0&&await chrome.storage.local.remove(n),this.stats.totalEntries=0,this.stats.hits=0,this.stats.misses=0,this.stats.hitRate=0,this.updateStats(),o.info("Cache cleared",{entriesRemoved:n.length})}catch(e){o.error("Failed to clear cache",e)}}getStats(){return{...this.stats}}async getAllCacheEntries(){try{const e=await chrome.storage.local.get(null),n=[];for(const[a,i]of Object.entries(e))a.startsWith("cache_")&&i&&typeof i=="object"&&n.push(i);return n.sort((a,i)=>i.timestamp-a.timestamp)}catch(e){return o.error("Failed to get all cache entries",e),[]}}updateHitRate(){const e=this.stats.hits+this.stats.misses;this.stats.hitRate=e>0?this.stats.hits/e:0}async updateStats(){try{const e=await this.getAllCacheEntries();e.length>0?(this.stats.oldestEntry=Math.min(...e.map(n=>n.timestamp)),this.stats.newestEntry=Math.max(...e.map(n=>n.timestamp))):(this.stats.oldestEntry=0,this.stats.newestEntry=0)}catch(e){o.error("Failed to update cache stats",e)}}async cleanupOldEntries(){try{const e=await I(),n=await this.getAllCacheEntries();if(n.length<=e.limits.maxCacheEntries)return;n.sort((s,r)=>s.timestamp-r.timestamp);const a=n.slice(0,n.length-e.limits.maxCacheEntries),i=a.map(s=>s.id);await chrome.storage.local.remove(i),this.stats.totalEntries=n.length-a.length,this.updateStats(),o.info("Cache cleanup completed",{removed:a.length,remaining:this.stats.totalEntries})}catch(e){o.error("Failed to cleanup old cache entries",e)}}}const L=new Z;async function b(t,e,n={}){return L.getCacheEntry(t,e,n)}async function S(t,e,n,a={}){return L.saveToCache(t,e,n,a)}async function Q(){return L.clearCache()}const q=Object.freeze(Object.defineProperty({__proto__:null,cacheManager:L,clearCache:Q,getCachedResponse:b,saveToCache:S},Symbol.toStringTag,{value:"Module"}));async function ee(t,e={}){const n=Date.now();try{o.info("Starting summarization",{textLength:t.length,options:Object.keys(e)});const a=await b(t,"summarize",e);if(a)return o.debug("Using cached summarization response"),{summary:a.text,metadata:{originalLength:t.length,summaryLength:a.text.length,compressionRatio:a.text.length/t.length,processingTime:Date.now()-n}};const s={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=t.substring(0,5e3)+"...");const c={prompt:te(t,s),maxTokens:ae(s.summaryLength||"medium"),temperature:.3},l=await v(c),u=ie(l.text,s),h=Date.now()-n,g={...u,metadata:{originalLength:t.length,summaryLength:u.summary.length,compressionRatio:u.summary.length/t.length,processingTime:h}};return await S("summarize",t,l,e),o.info("Summarization completed",{originalLength:g.metadata.originalLength,summaryLength:g.metadata.summaryLength,compressionRatio:g.metadata.compressionRatio,processingTime:g.metadata.processingTime}),g}catch(a){throw o.error("Summarization failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function te(t,e){const n=ne(e.summaryLength||"medium"),a=e.includeKeyPoints?" Also provide key points as a bulleted list.":"",i=e.focusAreas&&e.focusAreas.length>0?` Focus specifically on: ${e.focusAreas.join(", ")}.`:"";return`Summarize the following text clearly and concisely.

INSTRUCTIONS:
${n}${a}${i}
Focus on the main points and key information while maintaining accuracy and clarity.
Remove redundant information and present the core message effectively.

TEXT TO SUMMARIZE:
${t}

Please provide a well-structured summary that captures the essential information.`}function ne(t){switch(t){case"short":return"Provide a concise summary (1-2 sentences).";case"long":return"Provide a comprehensive summary with key details and context.";case"medium":default:return"Provide a balanced summary (3-5 sentences)."}}function ae(t){switch(t){case"short":return 150;case"long":return 500;case"medium":default:return 300}}function ie(t,e){const n=t.trim();if(!n)throw new Error("Empty response from AI service");const a={summary:n};if(e.includeKeyPoints){const i=re(n);i.length>0&&(a.keyPoints=i)}return a.confidence=se(n),a}function re(t){const e=[],n=t.split(`
`);for(const a of n){const i=a.trim();if(i.startsWith("•")||i.startsWith("-")||i.startsWith("*")||i.startsWith("◦")||/^\d+\./.test(i)){const s=i.replace(/^[•\-*◦]|\d+\./,"").trim();s.length>0&&e.push(s)}}return e}function se(t){let e=.5;t.length>=50&&t.length<=1e3&&(e+=.2);const n=t.split(/[.!?]+/).filter(a=>a.trim().length>0);return n.length>=2&&n.length<=10&&(e+=.2),(t.includes("The")||t.includes("This")||t.includes("It"))&&(e+=.1),Math.min(1,e)}async function oe(t,e={}){const n=Date.now();try{o.info("Starting text rewriting",{textLength:t.length,options:Object.keys(e)});const a=await b(t,"rewrite",e);if(a)return o.debug("Using cached rewrite response"),{rewrittenText:a.text,originalText:t,changes:$(t,a.text),metadata:{originalLength:t.length,rewrittenLength:a.text.length,processingTime:Date.now()-n}};const s={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=t.substring(0,5e3)+"...");const c={prompt:ce(t,s),maxTokens:Math.min(t.length*1.5,2e3),temperature:.4},l=await v(c),u=de(l.text),h=$(t,u),g=Date.now()-n,d={rewrittenText:u,originalText:t,changes:h,confidence:pe(t,u,s),metadata:{originalLength:t.length,rewrittenLength:u.length,processingTime:g}};return await S("rewrite",t,l,e),o.info("Text rewriting completed",{originalLength:d.metadata.originalLength,rewrittenLength:d.metadata.rewrittenLength,wordCountChange:d.changes.wordCountChange,processingTime:d.metadata.processingTime}),d}catch(a){throw o.error("Text rewriting failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function ce(t,e){const n=le(e.tone||"professional"),a=ue(e.style),i=ge(e.audience),s=e.improvements&&e.improvements.length>0?` Focus on these specific improvements: ${e.improvements.join(", ")}.`:"";return`Rewrite the following text to improve clarity, flow, and readability while preserving the original meaning and intent.

INSTRUCTIONS:
${n}${a}${i}${s}
Maintain the core message and key information while enhancing the writing quality.

ORIGINAL TEXT:
${t}

Please provide a rewritten version that is clearer, more engaging, and better structured.`}function le(t){switch(t){case"formal":return"Use a formal, professional tone with sophisticated vocabulary.";case"casual":return"Use a casual, conversational tone that is friendly and approachable.";case"professional":return"Use a professional, business-appropriate tone that is clear and authoritative.";case"creative":return"Use a creative, engaging tone with vivid language and compelling narrative.";case"academic":return"Use an academic tone with precise terminology and scholarly language.";case"conversational":return"Use a conversational tone that feels natural and easy to read.";default:return"Use a clear, polished tone."}}function ue(t){if(!t)return"";const e=[];return t.activeVoice&&e.push("Use active voice whenever possible."),t.simplify&&e.push("Simplify complex sentences and use clear, straightforward language."),t.descriptive&&e.push("Add descriptive language and vivid details where appropriate."),t.clarity&&e.push("Prioritize clarity and eliminate any ambiguity."),e.length>0?` ${e.join(" ")}`:""}function ge(t){if(!t)return"";switch(t){case"technical":return" Write for a technical audience familiar with specialized terminology.";case"academic":return" Write for an academic audience with scholarly expectations.";case"business":return" Write for a business audience focused on results and professionalism.";case"casual":return" Write for a casual audience that prefers simple, friendly language.";case"general":default:return" Write for a general audience that values clarity and accessibility."}}function de(t){const e=t.trim();if(!e)throw new Error("Empty response from AI service");const n=e.split(`
`);let a=0;for(let i=0;i<n.length;i++){const s=n[i].trim();if(s&&!s.toLowerCase().includes("rewritten")&&!s.toLowerCase().includes("version")){a=i;break}}return n.slice(a).join(`
`).trim()}function $(t,e){const n=t.split(/\s+/).length,a=e.split(/\s+/).length,i=t.split(/[.!?]+/).filter(r=>r.trim().length>0).length,s=e.split(/[.!?]+/).filter(r=>r.trim().length>0).length;return{wordCountChange:a-n,sentenceCountChange:s-i,readabilityScore:he(e)}}function he(t){const e=t.split(/[.!?]+/).filter(s=>s.trim().length>0).length,n=t.split(/\s+/).length,a=t.split(/\s+/).reduce((s,r)=>s+me(r),0);if(e===0||n===0)return 0;const i=206.835-1.015*(n/e)-84.6*(a/n);return Math.max(0,Math.min(100,i))}function me(t){const e=t.toLowerCase().replace(/[^a-z]/g,"");if(e.length===0)return 0;const n="aeiouy";let a=0,i=!1;for(let s=0;s<e.length;s++){const r=n.includes(e[s]);r&&!i&&a++,i=r}return e.endsWith("e")&&a>1&&a--,Math.max(1,a)}function pe(t,e,n){let a=.5;const i=e.length/t.length;i>=.7&&i<=1.5&&(a+=.2);const s=t.split(/[.!?]+/).filter(c=>c.trim().length>0).length,r=e.split(/[.!?]+/).filter(c=>c.trim().length>0).length;return r>0&&r<=s*1.5&&(a+=.2),n.tone&&fe(n.tone).filter(u=>e.toLowerCase().includes(u.toLowerCase())).length>0&&(a+=.1),Math.min(1,a)}function fe(t){switch(t){case"formal":return["therefore","furthermore","consequently","moreover"];case"casual":return["actually","really","pretty","kind of"];case"professional":return["recommend","suggest","propose","indicate"];case"creative":return["imagine","picture","envision","visualize"];default:return[]}}async function we(t,e={}){const n=Date.now();try{o.info("Starting ideation",{textLength:t.length,options:Object.keys(e)});const a=await b(t,"ideate",e);if(a){o.debug("Using cached ideation response");const p=U(a.text);return{ideas:p,context:{originalText:t,domain:e.domain,focusAreas:e.focusAreas,constraints:e.constraints},metadata:{ideaCount:p.length,processingTime:Date.now()-n}}}const s={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=t.substring(0,5e3)+"...");const c={prompt:ye(t,s),maxTokens:1500,temperature:.8},l=await v(c),u=U(l.text),h=Date.now()-n,g=be(u),d={ideas:u,context:{originalText:t,domain:e.domain,focusAreas:e.focusAreas,constraints:e.constraints},metadata:{ideaCount:u.length,processingTime:h,creativityScore:g}};return await S("ideate",t,l,e),o.info("Ideation completed",{ideaCount:d.metadata.ideaCount,creativityScore:d.metadata.creativityScore,processingTime:d.metadata.processingTime}),d}catch(a){throw o.error("Ideation failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function ye(t,e){const n=e.ideaCount||5,a=ve(e.ideaType||"mixed"),i=e.domain?` Focus on ideas relevant to the ${e.domain} domain.`:"",s=e.focusAreas&&e.focusAreas.length>0?` Pay special attention to: ${e.focusAreas.join(", ")}.`:"",r=e.constraints&&e.constraints.length>0?` Consider these constraints: ${e.constraints.join(", ")}.`:"",c=e.audience?` Tailor ideas for a ${e.audience} audience.`:"",l=e.timeframe?` Focus on ${e.timeframe}-term implementation ideas.`:"";return`Generate creative, innovative ideas based on the following text. Think outside the box and provide practical, actionable insights.

INSTRUCTIONS:
Generate ${n} distinct ideas.${a}${i}${s}${r}${c}${l}
Each idea should be specific, actionable, and build upon the content provided.

SOURCE TEXT:
${t}

For each idea, provide:
1. A clear, compelling title
2. A detailed description explaining the concept
3. Implementation steps or approach
4. Potential benefits
5. Potential challenges
6. Effort level (low/medium/high)
7. Impact level (low/medium/high)

Please format your response clearly with numbered ideas and organized sections.`}function ve(t){switch(t){case"creative":return" Focus on highly creative, innovative, and out-of-the-box ideas.";case"practical":return" Focus on practical, implementable ideas with clear benefits.";case"strategic":return" Focus on strategic, long-term thinking and planning ideas.";case"innovative":return" Focus on breakthrough innovations and novel approaches.";case"mixed":default:return" Provide a mix of creative, practical, and strategic ideas."}}function U(t){const e=[],n=t.split(`
`);let a={},i="";for(let s=0;s<n.length;s++){const r=n[s].trim();if(r){if(/^\d+\./.test(r)||/^idea\s+\d+/i.test(r)){a.title&&e.push(a),a={title:r.replace(/^\d+\.\s*/,"").replace(/^idea\s+\d+:\s*/i,"")},i="";continue}if(r.toLowerCase().includes("description")||r.toLowerCase().includes("explanation")){i="description";continue}else if(r.toLowerCase().includes("implementation")||r.toLowerCase().includes("steps")){i="implementation";continue}else if(r.toLowerCase().includes("benefits")||r.toLowerCase().includes("advantages")){i="benefits";continue}else if(r.toLowerCase().includes("challenges")||r.toLowerCase().includes("difficulties")){i="challenges";continue}else if(r.toLowerCase().includes("effort")||r.toLowerCase().includes("difficulty")){i="effort";continue}else if(r.toLowerCase().includes("impact")||r.toLowerCase().includes("effect")){i="impact";continue}if(i==="description")a.description=(a.description||"")+" "+r;else if(i==="implementation")a.implementation||(a.implementation=[]),a.implementation.push(r.replace(/^[-•*]\s*/,""));else if(i==="benefits")a.benefits||(a.benefits=[]),a.benefits.push(r.replace(/^[-•*]\s*/,""));else if(i==="challenges")a.challenges||(a.challenges=[]),a.challenges.push(r.replace(/^[-•*]\s*/,""));else if(i==="effort"){const c=r.toLowerCase();c.includes("low")?a.effortLevel="low":c.includes("high")?a.effortLevel="high":a.effortLevel="medium"}else if(i==="impact"){const c=r.toLowerCase();c.includes("low")?a.impactLevel="low":c.includes("high")?a.impactLevel="high":a.impactLevel="medium"}}}return a.title&&e.push(a),e.map(s=>{var r,c;return{...s,title:((r=s.title)==null?void 0:r.trim())||"Untitled Idea",description:((c=s.description)==null?void 0:c.trim())||"No description provided",implementation:s.implementation||[],benefits:s.benefits||[],challenges:s.challenges||[],effortLevel:s.effortLevel||"medium",impactLevel:s.impactLevel||"medium"}})}function be(t){if(t.length===0)return 0;let e=0,n=t.length;for(const a of t){let i=.2;a.title&&a.title.length>10&&(i+=.1),a.description&&a.description.length>50&&(i+=.2),a.implementation&&a.implementation.length>0&&(i+=.2),a.benefits&&a.benefits.length>0&&(i+=.1),a.challenges&&a.challenges.length>0&&(i+=.1),a.effortLevel&&a.impactLevel&&(i+=.1),e+=i}return Math.min(1,e/n)}async function Se(t,e={}){const n=Date.now();try{o.info("Starting translation",{textLength:t.length,options:Object.keys(e)});const i={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=t.substring(0,5e3)+"...");const s=i.sourceLanguage||await Ce(t),r=i.targetLanguage||"English",c=await b(t,"translate",i);if(c)return o.debug("Using cached translation response"),{translatedText:c.text,originalText:t,sourceLanguage:s,targetLanguage:r,metadata:{originalLength:t.length,translatedLength:c.text.length,processingTime:Date.now()-n}};const u={prompt:Ie(t,s,r,i),maxTokens:Math.min(t.length*2,3e3),temperature:.3},h=await v(u),g=Ee(h.text),d=Date.now()-n,p=Pe(t,g,s,r),f={translatedText:g,originalText:t,sourceLanguage:s,targetLanguage:r,confidence:Ae(t,g,s,r),metadata:{originalLength:t.length,translatedLength:g.length,processingTime:d,qualityScore:p}};return await S("translate",t,h,i),o.info("Translation completed",{sourceLanguage:f.sourceLanguage,targetLanguage:f.targetLanguage,originalLength:f.metadata.originalLength,translatedLength:f.metadata.translatedLength,processingTime:f.metadata.processingTime}),f}catch(a){throw o.error("Translation failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function Ie(t,e,n,a){const i=Te(a.style),s=Le(a.domain),r=a.culturalAdaptation?" Adapt cultural references and idioms appropriately for the target language and culture.":"",c=a.preserveFormatting?" Preserve all formatting, including line breaks, punctuation, and special characters.":"";return`Translate the following text from ${e} to ${n}.

INSTRUCTIONS:
${i}${s}${r}${c}
Maintain the original meaning, tone, and context while ensuring the translation reads naturally in ${n}.
Preserve any technical terms, proper nouns, or specialized vocabulary appropriately.

TEXT TO TRANSLATE:
${t}

Please provide an accurate, natural-sounding translation in ${n}.`}function Te(t){switch(t){case"formal":return"Use formal language and register appropriate for official or academic contexts.";case"informal":return"Use informal, conversational language that sounds natural and casual.";case"technical":return"Use precise technical terminology and maintain technical accuracy.";case"literary":return"Preserve literary style, metaphors, and artistic expression.";case"conversational":return"Use conversational tone that feels natural and easy to read.";default:return"Use clear, natural language appropriate for general communication."}}function Le(t){switch(t){case"business":return"Use business-appropriate language and terminology.";case"technical":return"Maintain technical accuracy and use precise technical terminology.";case"medical":return"Use accurate medical terminology and maintain clinical precision.";case"legal":return"Use precise legal terminology and maintain legal accuracy.";case"academic":return"Use scholarly language and maintain academic rigor.";default:return""}}async function Ce(t){const e={English:/^(the|and|or|but|in|on|at|to|for|of|with|by)\s/i,Spanish:/^(el|la|los|las|un|una|de|del|en|con|por|para)\s/i,French:/^(le|la|les|un|une|de|du|des|en|avec|pour|par)\s/i,German:/^(der|die|das|ein|eine|und|oder|aber|in|auf|mit|für)\s/i,Italian:/^(il|la|lo|gli|le|un|una|di|del|della|in|con|per)\s/i,Portuguese:/^(o|a|os|as|um|uma|de|do|da|em|com|para)\s/i,Russian:/^[а-яё]/i,Chinese:/[\u4e00-\u9fff]/,Japanese:/[\u3040-\u309f\u30a0-\u30ff]/,Korean:/[\uac00-\ud7af]/,Arabic:/[\u0600-\u06ff]/};for(const[n,a]of Object.entries(e))if(a.test(t))return n;return"English"}function Ee(t){const e=t.trim();if(!e)throw new Error("Empty response from AI service");const n=e.split(`
`);let a=0;for(let i=0;i<n.length;i++){const s=n[i].trim();if(s&&!s.toLowerCase().includes("translation")&&!s.toLowerCase().includes("translated")){a=i;break}}return n.slice(a).join(`
`).trim()}function Ae(t,e,n,a){let i=.5;const s=e.length/t.length;s>=.5&&s<=2&&(i+=.2);const r=t.split(/[.!?]+/).filter(g=>g.trim().length>0).length,c=e.split(/[.!?]+/).filter(g=>g.trim().length>0).length;Math.abs(r-c)<=1&&(i+=.2);const l=t.split(/\s+/).length,h=e.split(/\s+/).length/l;return h>=.7&&h<=1.5&&(i+=.1),Math.min(1,i)}function Pe(t,e,n,a){let i=.5;e.length>0&&(i+=.2),a==="English"&&/[a-zA-Z]/.test(e)&&(i+=.1);const s=t.split(/\n\s*\n/).length,r=e.split(/\n\s*\n/).length;Math.abs(s-r)<=1&&(i+=.1);const c=(t.match(/[.!?]/g)||[]).length,l=(e.match(/[.!?]/g)||[]).length;return Math.abs(c-l)<=2&&(i+=.1),Math.min(1,i)}async function x(){try{await G(),await k(),chrome.runtime.onMessage.addListener(ke),o.info("Message router initialized successfully")}catch(t){throw o.error("Failed to initialize message router",t),t}}async function ke(t,e,n){var s;const a=Date.now(),i=t.requestId||_e();try{if(o.debug("Message received",{action:t.action,requestId:i,source:t.source,tabId:t.tabId,senderId:(s=e.tab)==null?void 0:s.id}),!t.action)throw new Error("Action is required");let r;const c={processingTime:Date.now()-a,timestamp:new Date().toISOString(),action:t.action};switch(t.action){case"ping":r=await Oe();break;case"summarize":r=await Re(t.text,t.options);break;case"rewrite":r=await Me(t.text,t.options);break;case"ideate":r=await $e(t.text,t.options);break;case"translate":r=await Ue(t.text,t.options);break;case"verifyKey":r=await ze(t.options);break;case"getSettings":r=await Fe();break;case"updateSettings":r=await De(t.options);break;case"clearCache":r=await xe();break;default:throw new Error(`Unknown action: ${t.action}`)}const l={success:!0,data:r,requestId:i,metadata:c};return o.info("Message processed successfully",{action:t.action,requestId:i,processingTime:c.processingTime}),n(l),!0}catch(r){const c=Date.now()-a;o.error("Message processing failed",r,{action:t.action,requestId:i,processingTime:c});const l={success:!1,error:r instanceof Error?r.message:"Unknown error occurred",requestId:i,metadata:{processingTime:c,timestamp:new Date().toISOString(),action:t.action}};return n(l),!0}}async function Oe(){return{status:"pong",timestamp:new Date().toISOString()}}async function Re(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for summarization");return await ee(t,e)}async function Me(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for rewriting");return await oe(t,e)}async function $e(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for ideation");return await we(t,e)}async function Ue(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for translation");return await Se(t,e)}async function Fe(){const{settingsManager:t}=await T(async()=>{const{settingsManager:e}=await Promise.resolve().then(()=>F);return{settingsManager:e}},void 0);return t.getSettings()}async function De(t){const{settingsManager:e}=await T(async()=>{const{settingsManager:n}=await Promise.resolve().then(()=>F);return{settingsManager:n}},void 0);return t.user&&await e.updateUserSettings(t.user),t.providers&&await e.updateProviderSettings(t.providers),e.getSettings()}async function ze(t){const{verifyKey:e}=await T(async()=>{const{verifyKey:a}=await Promise.resolve().then(()=>Y);return{verifyKey:a}},void 0);if(!t.provider||!t.apiKey)throw new Error("Provider and API key are required");return{valid:await e(t.provider,t.apiKey),provider:t.provider}}async function xe(){const{clearCache:t}=await T(async()=>{const{clearCache:e}=await Promise.resolve().then(()=>q);return{clearCache:e}},void 0);return await t(),{message:"Cache cleared successfully"}}function _e(){return`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async function je(t,e){try{const n=await chrome.tabs.sendMessage(t,e);return o.debug("Message sent to content script",{tabId:t,messageType:e.type}),n}catch(n){throw o.error("Failed to send message to content script",n,{tabId:t}),n}}function Ne(){chrome.tabs.onUpdated.addListener((t,e,n)=>{e.status==="complete"&&n.url&&(o.debug("Tab updated",{tabId:t,url:n.url}),je(t,{type:"tabUpdated",url:n.url,timestamp:new Date().toISOString()}).catch(a=>{o.debug("Failed to notify content script of tab update",{tabId:t,error:a.message})}))})}function We(){chrome.runtime.onInstalled.addListener(t=>{o.info("Extension installed/updated",{reason:t.reason,previousVersion:t.previousVersion}),t.reason==="install"&&k().catch(e=>{o.error("Failed to initialize settings on install",e)})})}function Ke(){chrome.runtime.onStartup.addListener(()=>{o.info("Extension started"),x().catch(t=>{o.error("Failed to reinitialize message router on startup",t)})})}function Ge(){Ne(),We(),Ke()}async function He(){try{await x(),Ge(),o.info("MuseFlow backend initialized successfully")}catch(t){throw o.error("Failed to initialize MuseFlow backend",t),t}}He().catch(t=>{console.error("Failed to initialize MuseFlow backend:",t)});chrome.runtime.onInstalled.addListener(t=>{o.info("Extension installed/updated",{reason:t.reason,previousVersion:t.previousVersion}),chrome.contextMenus.create({id:"museflow-summarize",title:"Summarize with MuseFlow",contexts:["selection"]}),chrome.contextMenus.create({id:"museflow-rewrite",title:"Rewrite with MuseFlow",contexts:["selection"]}),chrome.contextMenus.create({id:"museflow-ideate",title:"Ideate with MuseFlow",contexts:["selection"]}),chrome.contextMenus.create({id:"museflow-translate",title:"Translate with MuseFlow",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener((t,e)=>{var a;if(!t.selectionText||!(e!=null&&e.id))return;const n=(a=t.menuItemId)==null?void 0:a.replace("museflow-","");n&&["summarize","rewrite","ideate","translate"].includes(n)&&chrome.tabs.sendMessage(e.id,{type:"TRIGGER_ACTION",action:n,text:t.selectionText,source:"contextMenu"}).catch(i=>{o.error("Failed to send message to content script",i,{tabId:e.id,action:n})})});
