var z=Object.defineProperty;var _=(t,e,n)=>e in t?z(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var p=(t,e,n)=>_(t,typeof e!="symbol"?e+"":e,n);import{_ as C}from"../../assets/preload-helper-D7HrI6pR.js";var E=(t=>(t[t.DEBUG=0]="DEBUG",t[t.INFO=1]="INFO",t[t.WARN=2]="WARN",t[t.ERROR=3]="ERROR",t))(E||{});class j{constructor(){p(this,"currentLevel",1);p(this,"logs",[]);p(this,"maxLogs",1e3)}setLevel(e){this.currentLevel=e}getLevel(){return this.currentLevel}debug(e,n){this.log(0,e,n)}info(e,n){this.log(1,e,n)}warn(e,n){this.log(2,e,n)}error(e,n,a){this.log(3,e,{...a,error:n})}log(e,n,a){if(e<this.currentLevel)return;const s={timestamp:new Date().toISOString(),level:e,message:n,context:a};this.logs.push(s),this.logs.length>this.maxLogs&&this.logs.shift();const i=this.formatMessage(s);switch(e){case 0:console.debug(i,a);break;case 1:console.info(i,a);break;case 2:console.warn(i,a);break;case 3:console.error(i,a);break}e>=2&&this.storeInChromeStorage(s)}formatMessage(e){const n=E[e.level];return`[${new Date(e.timestamp).toLocaleTimeString()}] [${n}] ${e.message}`}async storeInChromeStorage(e){try{const a=(await chrome.storage.local.get(["logs"])).logs||[];a.push(e),a.length>50&&a.splice(0,a.length-50),await chrome.storage.local.set({logs:a})}catch(n){console.error("Failed to store log in Chrome storage:",n)}}getLogs(e=100){return this.logs.slice(-e)}clearLogs(){this.logs=[]}async getStoredLogs(){try{return(await chrome.storage.local.get(["logs"])).logs||[]}catch(e){return console.error("Failed to get stored logs:",e),[]}}async clearStoredLogs(){try{await chrome.storage.local.remove(["logs"])}catch(e){console.error("Failed to clear stored logs:",e)}}}const o=new j;async function N(){try{const t=await chrome.storage.sync.get(["logLevel"]);t.logLevel!==void 0&&o.setLevel(t.logLevel),o.info("Logging initialized",{level:E[o.getLevel()],timestamp:new Date().toISOString()})}catch(t){console.error("Failed to initialize logging:",t)}}const O={defaultLanguage:"English",defaultTone:"professional",defaultSummaryLength:"medium",preferredProvider:"chrome",autoCache:!0,showDebugInfo:!1,keyboardShortcuts:!0,popupPosition:"top",theme:"auto",animations:!0,soundEffects:!1,autoExpandPopup:!1,contextWindowSize:1e3},A={requestTimeout:3e4,maxRetries:3,rateLimit:{requestsPerMinute:60,requestsPerHour:1e3}},w={user:O,providers:A,lastUpdated:Date.now(),version:"1.0.0"};class W{constructor(){p(this,"settings",w);p(this,"isInitialized",!1)}async initialize(){try{const e=await chrome.storage.sync.get(["appSettings"]);e.appSettings?(this.settings={...w,...e.appSettings},o.debug("Settings loaded from storage",{version:this.settings.version,lastUpdated:new Date(this.settings.lastUpdated).toISOString()})):(await this.saveSettings(),o.debug("Default settings initialized")),this.isInitialized=!0}catch(e){o.error("Failed to initialize settings",e),this.settings=w,this.isInitialized=!0}}getSettings(){return{...this.settings}}getUserSettings(){return{...this.settings.user}}getProviderSettings(){return{...this.settings.providers}}async updateUserSettings(e){try{this.settings.user={...this.settings.user,...e},this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.info("User settings updated",{updates:Object.keys(e),timestamp:new Date(this.settings.lastUpdated).toISOString()})}catch(n){throw o.error("Failed to update user settings",n,{updates:e}),n}}async updateProviderSettings(e){try{this.settings.providers={...this.settings.providers,...e},this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.info("Provider settings updated",{updates:Object.keys(e),timestamp:new Date(this.settings.lastUpdated).toISOString()})}catch(n){throw o.error("Failed to update provider settings",n,{updates:e}),n}}getDefaultPromptOptions(){return{targetLanguage:this.settings.user.defaultLanguage,tone:this.settings.user.defaultTone,summaryLength:this.settings.user.defaultSummaryLength}}async resetSettings(){try{this.settings={...w},await this.saveSettings(),o.info("Settings reset to defaults")}catch(e){throw o.error("Failed to reset settings",e),e}}exportSettings(){return JSON.stringify(this.settings,null,2)}async importSettings(e){try{const n=JSON.parse(e);if(!n.user||!n.providers)throw new Error("Invalid settings format");this.settings={user:{...O,...n.user},providers:{...A,...n.providers},lastUpdated:Date.now(),version:n.version||w.version},await this.saveSettings(),o.info("Settings imported successfully",{version:this.settings.version})}catch(n){throw o.error("Failed to import settings",n),n}}async saveSettings(){try{await chrome.storage.sync.set({appSettings:this.settings}),o.debug("Settings saved to storage")}catch(e){throw o.error("Failed to save settings to storage",e),e}}isReady(){return this.isInitialized}getSettingValue(e){const n=e.split(".");let a=this.settings;for(const s of n)if(a&&typeof a=="object"&&s in a)a=a[s];else return;return a}async setSettingValue(e,n){const a=e.split("."),s=a.pop();let i=this.settings;for(const r of a)(!i[r]||typeof i[r]!="object")&&(i[r]={}),i=i[r];i[s]=n,this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.debug("Setting value updated",{path:e,value:n})}}const P=new W;async function M(){return P.initialize()}function y(){return P.getDefaultPromptOptions()}const F=Object.freeze(Object.defineProperty({__proto__:null,defaultAppSettings:w,defaultProviderSettings:A,defaultUserSettings:O,getDefaultPromptOptions:y,initializeSettings:M,settingsManager:P},Symbol.toStringTag,{value:"Module"}));var R={};const k={ai:{provider:"chrome",openai:{apiKey:R.OPENAI_API_KEY||"",model:"gpt-3.5-turbo",baseUrl:"https://api.openai.com/v1"},chrome:{model:"gemini-pro"},gemini:{apiKey:R.GEMINI_API_KEY||"",model:"gemini-pro"}},limits:{maxTextLength:5e3,maxCacheEntries:100,cacheTtl:24*60*60*1e3},features:{enableCaching:!0,enableLogging:!0,enableFallback:!0}};async function I(){try{const t=await chrome.storage.sync.get(["config"]);return{...k,...t.config}}catch(t){return console.warn("Failed to load config from storage, using defaults:",t),k}}async function T(t){const e=await I();try{if(e.ai.provider==="chrome"&&chrome.ai){o.debug("Attempting Chrome AI API call",{model:e.ai.chrome.model});const n=await K(t,e.ai.chrome.model);return o.info("Chrome AI API call successful",{provider:"chrome",model:e.ai.chrome.model,responseLength:n.text.length}),n}if(e.features.enableFallback&&e.ai.openai.apiKey){o.debug("Falling back to OpenAI API",{model:e.ai.openai.model});const n=await H(t,e.ai.openai);return o.info("OpenAI API call successful",{provider:"openai",model:e.ai.openai.model,responseLength:n.text.length}),n}if(e.features.enableFallback&&e.ai.gemini.apiKey){o.debug("Falling back to Gemini API",{model:e.ai.gemini.model});const n=await G(t,e.ai.gemini);return o.info("Gemini API call successful",{provider:"gemini",model:e.ai.gemini.model,responseLength:n.text.length}),n}throw new Error("No AI provider available")}catch(n){throw o.error("AI API call failed",n,{provider:e.ai.provider,request:{promptLength:t.prompt.length}}),n}}async function K(t,e){if(!chrome.ai)throw new Error("Chrome AI API not available");try{return{text:await new Promise(a=>{setTimeout(()=>{a(`Chrome AI response for: ${t.prompt.substring(0,100)}...`)},1e3)}),model:e,provider:"chrome",timestamp:new Date().toISOString()}}catch(n){throw new Error(`Chrome AI API call failed: ${n}`)}}async function H(t,e){var s,i,r,c;const n=await fetch(`${e.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.model,messages:[{role:"user",content:t.prompt}],max_tokens:t.maxTokens||1e3,temperature:t.temperature||.7})});if(!n.ok){const l=await n.json().catch(()=>({}));throw new Error(`OpenAI API error: ${n.status} ${((s=l.error)==null?void 0:s.message)||n.statusText}`)}const a=await n.json();return{text:((r=(i=a.choices[0])==null?void 0:i.message)==null?void 0:r.content)||"",model:e.model,provider:"openai",timestamp:new Date().toISOString(),tokensUsed:(c=a.usage)==null?void 0:c.total_tokens}}async function G(t,e){var s,i,r,c;const n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${e.model}:generateContent?key=${e.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:t.prompt}]}],generationConfig:{temperature:t.temperature||.7,maxOutputTokens:t.maxTokens||1e3}})});if(!n.ok){const l=await n.json().catch(()=>({}));throw new Error(`Gemini API error: ${n.status} ${((s=l.error)==null?void 0:s.message)||n.statusText}`)}return{text:((c=(r=(i=(await n.json()).candidates[0])==null?void 0:i.content)==null?void 0:r.parts[0])==null?void 0:c.text)||"",model:e.model,provider:"gemini",timestamp:new Date().toISOString()}}class V{constructor(){p(this,"stats",{totalEntries:0,hits:0,misses:0,hitRate:0,oldestEntry:0,newestEntry:0})}generateHash(e,n){const a=`${n}:${e}`;let s=0;for(let i=0;i<a.length;i++){const r=a.charCodeAt(i);s=(s<<5)-s+r,s=s&s}return s.toString(36)}async getCacheEntry(e,n){try{if(!(await I()).features.enableCaching)return this.stats.misses++,this.updateHitRate(),null;const s=this.generateHash(e,n),i=`cache_${s}`,c=(await chrome.storage.local.get([i]))[i];if(!c)return this.stats.misses++,this.updateHitRate(),o.debug("Cache miss",{action:n,inputHash:s}),null;const l=Date.now();return l>c.timestamp+c.ttl?(await this.removeCacheEntry(i),this.stats.misses++,this.updateHitRate(),o.debug("Cache entry expired",{action:n,inputHash:s,age:l-c.timestamp}),null):(this.stats.hits++,this.updateHitRate(),o.debug("Cache hit",{action:n,inputHash:s,age:l-c.timestamp}),c.response)}catch(a){return o.error("Failed to get cache entry",a,{action:n}),this.stats.misses++,this.updateHitRate(),null}}async saveToCache(e,n,a){try{const s=await I();if(!s.features.enableCaching)return;const i=this.generateHash(n,e),r=`cache_${i}`,c={id:r,inputText:n,response:a,timestamp:Date.now(),ttl:s.limits.cacheTtl,action:e,inputHash:i};await chrome.storage.local.set({[r]:c}),this.stats.totalEntries++,this.updateStats(),o.debug("Response cached",{action:e,inputHash:i,responseLength:a.text.length}),await this.cleanupOldEntries()}catch(s){o.error("Failed to save to cache",s,{action:e})}}async removeCacheEntry(e){try{await chrome.storage.local.remove([e]),this.stats.totalEntries=Math.max(0,this.stats.totalEntries-1),this.updateStats(),o.debug("Cache entry removed",{cacheKey:e})}catch(n){o.error("Failed to remove cache entry",n,{cacheKey:e})}}async clearCache(){try{const e=await chrome.storage.local.get(null),n=Object.keys(e).filter(a=>a.startsWith("cache_"));n.length>0&&await chrome.storage.local.remove(n),this.stats.totalEntries=0,this.stats.hits=0,this.stats.misses=0,this.stats.hitRate=0,this.updateStats(),o.info("Cache cleared",{entriesRemoved:n.length})}catch(e){o.error("Failed to clear cache",e)}}getStats(){return{...this.stats}}async getAllCacheEntries(){try{const e=await chrome.storage.local.get(null),n=[];for(const[a,s]of Object.entries(e))a.startsWith("cache_")&&s&&typeof s=="object"&&n.push(s);return n.sort((a,s)=>s.timestamp-a.timestamp)}catch(e){return o.error("Failed to get all cache entries",e),[]}}updateHitRate(){const e=this.stats.hits+this.stats.misses;this.stats.hitRate=e>0?this.stats.hits/e:0}async updateStats(){try{const e=await this.getAllCacheEntries();e.length>0?(this.stats.oldestEntry=Math.min(...e.map(n=>n.timestamp)),this.stats.newestEntry=Math.max(...e.map(n=>n.timestamp))):(this.stats.oldestEntry=0,this.stats.newestEntry=0)}catch(e){o.error("Failed to update cache stats",e)}}async cleanupOldEntries(){try{const e=await I(),n=await this.getAllCacheEntries();if(n.length<=e.limits.maxCacheEntries)return;n.sort((i,r)=>i.timestamp-r.timestamp);const a=n.slice(0,n.length-e.limits.maxCacheEntries),s=a.map(i=>i.id);await chrome.storage.local.remove(s),this.stats.totalEntries=n.length-a.length,this.updateStats(),o.info("Cache cleanup completed",{removed:a.length,remaining:this.stats.totalEntries})}catch(e){o.error("Failed to cleanup old cache entries",e)}}}const L=new V;async function v(t,e){return L.getCacheEntry(t,e)}async function S(t,e,n){return L.saveToCache(t,e,n)}async function J(){return L.clearCache()}const X=Object.freeze(Object.defineProperty({__proto__:null,cacheManager:L,clearCache:J,getCachedResponse:v,saveToCache:S},Symbol.toStringTag,{value:"Module"}));async function B(t,e={}){const n=Date.now();try{o.info("Starting summarization",{textLength:t.length,options:Object.keys(e)});const a=`summarize:${JSON.stringify(e)}:${t.substring(0,100)}`,s=await v(a,"summarize");if(s)return o.debug("Using cached summarization response"),{summary:s.text,metadata:{originalLength:t.length,summaryLength:s.text.length,compressionRatio:s.text.length/t.length,processingTime:Date.now()-n}};const r={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=t.substring(0,5e3)+"...");const l={prompt:Y(t,r),maxTokens:Q(r.summaryLength||"medium"),temperature:.3},d=await T(l),u=q(d.text,r),h=Date.now()-n,g={...u,metadata:{originalLength:t.length,summaryLength:u.summary.length,compressionRatio:u.summary.length/t.length,processingTime:h}};return await S("summarize",a,d),o.info("Summarization completed",{originalLength:g.metadata.originalLength,summaryLength:g.metadata.summaryLength,compressionRatio:g.metadata.compressionRatio,processingTime:g.metadata.processingTime}),g}catch(a){throw o.error("Summarization failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function Y(t,e){const n=Z(e.summaryLength||"medium"),a=e.includeKeyPoints?" Also provide key points as a bulleted list.":"",s=e.focusAreas&&e.focusAreas.length>0?` Focus specifically on: ${e.focusAreas.join(", ")}.`:"";return`Summarize the following text clearly and concisely.

INSTRUCTIONS:
${n}${a}${s}
Focus on the main points and key information while maintaining accuracy and clarity.
Remove redundant information and present the core message effectively.

TEXT TO SUMMARIZE:
${t}

Please provide a well-structured summary that captures the essential information.`}function Z(t){switch(t){case"short":return"Provide a concise summary (1-2 sentences).";case"long":return"Provide a comprehensive summary with key details and context.";case"medium":default:return"Provide a balanced summary (3-5 sentences)."}}function Q(t){switch(t){case"short":return 150;case"long":return 500;case"medium":default:return 300}}function q(t,e){const n=t.trim();if(!n)throw new Error("Empty response from AI service");const a={summary:n};if(e.includeKeyPoints){const s=ee(n);s.length>0&&(a.keyPoints=s)}return a.confidence=te(n),a}function ee(t){const e=[],n=t.split(`
`);for(const a of n){const s=a.trim();if(s.startsWith("•")||s.startsWith("-")||s.startsWith("*")||s.startsWith("◦")||/^\d+\./.test(s)){const i=s.replace(/^[•\-*◦]|\d+\./,"").trim();i.length>0&&e.push(i)}}return e}function te(t){let e=.5;t.length>=50&&t.length<=1e3&&(e+=.2);const n=t.split(/[.!?]+/).filter(a=>a.trim().length>0);return n.length>=2&&n.length<=10&&(e+=.2),(t.includes("The")||t.includes("This")||t.includes("It"))&&(e+=.1),Math.min(1,e)}async function ne(t,e={}){const n=Date.now();try{o.info("Starting text rewriting",{textLength:t.length,options:Object.keys(e)});const a=`rewrite:${JSON.stringify(e)}:${t.substring(0,100)}`,s=await v(a,"rewrite");if(s)return o.debug("Using cached rewrite response"),{rewrittenText:s.text,originalText:t,changes:$(t,s.text),metadata:{originalLength:t.length,rewrittenLength:s.text.length,processingTime:Date.now()-n}};const r={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=t.substring(0,5e3)+"...");const l={prompt:ae(t,r),maxTokens:Math.min(t.length*1.5,2e3),temperature:.4},d=await T(l),u=oe(d.text),h=$(t,u),g=Date.now()-n,m={rewrittenText:u,originalText:t,changes:h,confidence:ue(t,u,r),metadata:{originalLength:t.length,rewrittenLength:u.length,processingTime:g}};return await S("rewrite",a,d),o.info("Text rewriting completed",{originalLength:m.metadata.originalLength,rewrittenLength:m.metadata.rewrittenLength,wordCountChange:m.changes.wordCountChange,processingTime:m.metadata.processingTime}),m}catch(a){throw o.error("Text rewriting failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function ae(t,e){const n=se(e.tone||"professional"),a=ie(e.style),s=re(e.audience),i=e.improvements&&e.improvements.length>0?` Focus on these specific improvements: ${e.improvements.join(", ")}.`:"";return`Rewrite the following text to improve clarity, flow, and readability while preserving the original meaning and intent.

INSTRUCTIONS:
${n}${a}${s}${i}
Maintain the core message and key information while enhancing the writing quality.

ORIGINAL TEXT:
${t}

Please provide a rewritten version that is clearer, more engaging, and better structured.`}function se(t){switch(t){case"formal":return"Use a formal, professional tone with sophisticated vocabulary.";case"casual":return"Use a casual, conversational tone that is friendly and approachable.";case"professional":return"Use a professional, business-appropriate tone that is clear and authoritative.";case"creative":return"Use a creative, engaging tone with vivid language and compelling narrative.";case"academic":return"Use an academic tone with precise terminology and scholarly language.";case"conversational":return"Use a conversational tone that feels natural and easy to read.";default:return"Use a clear, polished tone."}}function ie(t){if(!t)return"";const e=[];return t.activeVoice&&e.push("Use active voice whenever possible."),t.simplify&&e.push("Simplify complex sentences and use clear, straightforward language."),t.descriptive&&e.push("Add descriptive language and vivid details where appropriate."),t.clarity&&e.push("Prioritize clarity and eliminate any ambiguity."),e.length>0?` ${e.join(" ")}`:""}function re(t){if(!t)return"";switch(t){case"technical":return" Write for a technical audience familiar with specialized terminology.";case"academic":return" Write for an academic audience with scholarly expectations.";case"business":return" Write for a business audience focused on results and professionalism.";case"casual":return" Write for a casual audience that prefers simple, friendly language.";case"general":default:return" Write for a general audience that values clarity and accessibility."}}function oe(t){const e=t.trim();if(!e)throw new Error("Empty response from AI service");const n=e.split(`
`);let a=0;for(let s=0;s<n.length;s++){const i=n[s].trim();if(i&&!i.toLowerCase().includes("rewritten")&&!i.toLowerCase().includes("version")){a=s;break}}return n.slice(a).join(`
`).trim()}function $(t,e){const n=t.split(/\s+/).length,a=e.split(/\s+/).length,s=t.split(/[.!?]+/).filter(r=>r.trim().length>0).length,i=e.split(/[.!?]+/).filter(r=>r.trim().length>0).length;return{wordCountChange:a-n,sentenceCountChange:i-s,readabilityScore:ce(e)}}function ce(t){const e=t.split(/[.!?]+/).filter(i=>i.trim().length>0).length,n=t.split(/\s+/).length,a=t.split(/\s+/).reduce((i,r)=>i+le(r),0);if(e===0||n===0)return 0;const s=206.835-1.015*(n/e)-84.6*(a/n);return Math.max(0,Math.min(100,s))}function le(t){const e=t.toLowerCase().replace(/[^a-z]/g,"");if(e.length===0)return 0;const n="aeiouy";let a=0,s=!1;for(let i=0;i<e.length;i++){const r=n.includes(e[i]);r&&!s&&a++,s=r}return e.endsWith("e")&&a>1&&a--,Math.max(1,a)}function ue(t,e,n){let a=.5;const s=e.length/t.length;s>=.7&&s<=1.5&&(a+=.2);const i=t.split(/[.!?]+/).filter(c=>c.trim().length>0).length,r=e.split(/[.!?]+/).filter(c=>c.trim().length>0).length;return r>0&&r<=i*1.5&&(a+=.2),n.tone&&ge(n.tone).filter(d=>e.toLowerCase().includes(d.toLowerCase())).length>0&&(a+=.1),Math.min(1,a)}function ge(t){switch(t){case"formal":return["therefore","furthermore","consequently","moreover"];case"casual":return["actually","really","pretty","kind of"];case"professional":return["recommend","suggest","propose","indicate"];case"creative":return["imagine","picture","envision","visualize"];default:return[]}}async function de(t,e={}){const n=Date.now();try{o.info("Starting ideation",{textLength:t.length,options:Object.keys(e)});const a=`ideate:${JSON.stringify(e)}:${t.substring(0,100)}`,s=await v(a,"ideate");if(s){o.debug("Using cached ideation response");const b=x(s.text);return{ideas:b,context:{originalText:t,domain:e.domain,focusAreas:e.focusAreas,constraints:e.constraints},metadata:{ideaCount:b.length,processingTime:Date.now()-n}}}const r={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=t.substring(0,5e3)+"...");const l={prompt:he(t,r),maxTokens:1500,temperature:.8},d=await T(l),u=x(d.text),h=Date.now()-n,g=pe(u),m={ideas:u,context:{originalText:t,domain:e.domain,focusAreas:e.focusAreas,constraints:e.constraints},metadata:{ideaCount:u.length,processingTime:h,creativityScore:g}};return await S("ideate",a,d),o.info("Ideation completed",{ideaCount:m.metadata.ideaCount,creativityScore:m.metadata.creativityScore,processingTime:m.metadata.processingTime}),m}catch(a){throw o.error("Ideation failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function he(t,e){const n=e.ideaCount||5,a=me(e.ideaType||"mixed"),s=e.domain?` Focus on ideas relevant to the ${e.domain} domain.`:"",i=e.focusAreas&&e.focusAreas.length>0?` Pay special attention to: ${e.focusAreas.join(", ")}.`:"",r=e.constraints&&e.constraints.length>0?` Consider these constraints: ${e.constraints.join(", ")}.`:"",c=e.audience?` Tailor ideas for a ${e.audience} audience.`:"",l=e.timeframe?` Focus on ${e.timeframe}-term implementation ideas.`:"";return`Generate creative, innovative ideas based on the following text. Think outside the box and provide practical, actionable insights.

INSTRUCTIONS:
Generate ${n} distinct ideas.${a}${s}${i}${r}${c}${l}
Each idea should be specific, actionable, and build upon the content provided.

SOURCE TEXT:
${t}

For each idea, provide:
1. A clear, compelling title
2. A detailed description explaining the concept
3. Implementation steps or approach
4. Potential benefits
5. Potential challenges
6. Effort level (low/medium/high)
7. Impact level (low/medium/high)

Please format your response clearly with numbered ideas and organized sections.`}function me(t){switch(t){case"creative":return" Focus on highly creative, innovative, and out-of-the-box ideas.";case"practical":return" Focus on practical, implementable ideas with clear benefits.";case"strategic":return" Focus on strategic, long-term thinking and planning ideas.";case"innovative":return" Focus on breakthrough innovations and novel approaches.";case"mixed":default:return" Provide a mix of creative, practical, and strategic ideas."}}function x(t){const e=[],n=t.split(`
`);let a={},s="";for(let i=0;i<n.length;i++){const r=n[i].trim();if(r){if(/^\d+\./.test(r)||/^idea\s+\d+/i.test(r)){a.title&&e.push(a),a={title:r.replace(/^\d+\.\s*/,"").replace(/^idea\s+\d+:\s*/i,"")},s="";continue}if(r.toLowerCase().includes("description")||r.toLowerCase().includes("explanation")){s="description";continue}else if(r.toLowerCase().includes("implementation")||r.toLowerCase().includes("steps")){s="implementation";continue}else if(r.toLowerCase().includes("benefits")||r.toLowerCase().includes("advantages")){s="benefits";continue}else if(r.toLowerCase().includes("challenges")||r.toLowerCase().includes("difficulties")){s="challenges";continue}else if(r.toLowerCase().includes("effort")||r.toLowerCase().includes("difficulty")){s="effort";continue}else if(r.toLowerCase().includes("impact")||r.toLowerCase().includes("effect")){s="impact";continue}if(s==="description")a.description=(a.description||"")+" "+r;else if(s==="implementation")a.implementation||(a.implementation=[]),a.implementation.push(r.replace(/^[-•*]\s*/,""));else if(s==="benefits")a.benefits||(a.benefits=[]),a.benefits.push(r.replace(/^[-•*]\s*/,""));else if(s==="challenges")a.challenges||(a.challenges=[]),a.challenges.push(r.replace(/^[-•*]\s*/,""));else if(s==="effort"){const c=r.toLowerCase();c.includes("low")?a.effortLevel="low":c.includes("high")?a.effortLevel="high":a.effortLevel="medium"}else if(s==="impact"){const c=r.toLowerCase();c.includes("low")?a.impactLevel="low":c.includes("high")?a.impactLevel="high":a.impactLevel="medium"}}}return a.title&&e.push(a),e.map(i=>{var r,c;return{...i,title:((r=i.title)==null?void 0:r.trim())||"Untitled Idea",description:((c=i.description)==null?void 0:c.trim())||"No description provided",implementation:i.implementation||[],benefits:i.benefits||[],challenges:i.challenges||[],effortLevel:i.effortLevel||"medium",impactLevel:i.impactLevel||"medium"}})}function pe(t){if(t.length===0)return 0;let e=0,n=t.length;for(const a of t){let s=.2;a.title&&a.title.length>10&&(s+=.1),a.description&&a.description.length>50&&(s+=.2),a.implementation&&a.implementation.length>0&&(s+=.2),a.benefits&&a.benefits.length>0&&(s+=.1),a.challenges&&a.challenges.length>0&&(s+=.1),a.effortLevel&&a.impactLevel&&(s+=.1),e+=s}return Math.min(1,e/n)}async function fe(t,e={}){const n=Date.now();try{o.info("Starting translation",{textLength:t.length,options:Object.keys(e)});const s={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=t.substring(0,5e3)+"...");const i=s.sourceLanguage||await Se(t),r=s.targetLanguage||"English",c=`translate:${i}:${r}:${JSON.stringify(s)}:${t.substring(0,100)}`,l=await v(c,"translate");if(l)return o.debug("Using cached translation response"),{translatedText:l.text,originalText:t,sourceLanguage:i,targetLanguage:r,metadata:{originalLength:t.length,translatedLength:l.text.length,processingTime:Date.now()-n}};const u={prompt:we(t,i,r,s),maxTokens:Math.min(t.length*2,3e3),temperature:.3},h=await T(u),g=be(h.text),m=Date.now()-n,b=Te(t,g,i,r),f={translatedText:g,originalText:t,sourceLanguage:i,targetLanguage:r,confidence:Ie(t,g,i,r),metadata:{originalLength:t.length,translatedLength:g.length,processingTime:m,qualityScore:b}};return await S("translate",c,h),o.info("Translation completed",{sourceLanguage:f.sourceLanguage,targetLanguage:f.targetLanguage,originalLength:f.metadata.originalLength,translatedLength:f.metadata.translatedLength,processingTime:f.metadata.processingTime}),f}catch(a){throw o.error("Translation failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function we(t,e,n,a){const s=ye(a.style),i=ve(a.domain),r=a.culturalAdaptation?" Adapt cultural references and idioms appropriately for the target language and culture.":"",c=a.preserveFormatting?" Preserve all formatting, including line breaks, punctuation, and special characters.":"";return`Translate the following text from ${e} to ${n}.

INSTRUCTIONS:
${s}${i}${r}${c}
Maintain the original meaning, tone, and context while ensuring the translation reads naturally in ${n}.
Preserve any technical terms, proper nouns, or specialized vocabulary appropriately.

TEXT TO TRANSLATE:
${t}

Please provide an accurate, natural-sounding translation in ${n}.`}function ye(t){switch(t){case"formal":return"Use formal language and register appropriate for official or academic contexts.";case"informal":return"Use informal, conversational language that sounds natural and casual.";case"technical":return"Use precise technical terminology and maintain technical accuracy.";case"literary":return"Preserve literary style, metaphors, and artistic expression.";case"conversational":return"Use conversational tone that feels natural and easy to read.";default:return"Use clear, natural language appropriate for general communication."}}function ve(t){switch(t){case"business":return"Use business-appropriate language and terminology.";case"technical":return"Maintain technical accuracy and use precise technical terminology.";case"medical":return"Use accurate medical terminology and maintain clinical precision.";case"legal":return"Use precise legal terminology and maintain legal accuracy.";case"academic":return"Use scholarly language and maintain academic rigor.";default:return""}}async function Se(t){const e={English:/^(the|and|or|but|in|on|at|to|for|of|with|by)\s/i,Spanish:/^(el|la|los|las|un|una|de|del|en|con|por|para)\s/i,French:/^(le|la|les|un|une|de|du|des|en|avec|pour|par)\s/i,German:/^(der|die|das|ein|eine|und|oder|aber|in|auf|mit|für)\s/i,Italian:/^(il|la|lo|gli|le|un|una|di|del|della|in|con|per)\s/i,Portuguese:/^(o|a|os|as|um|uma|de|do|da|em|com|para)\s/i,Russian:/^[а-яё]/i,Chinese:/[\u4e00-\u9fff]/,Japanese:/[\u3040-\u309f\u30a0-\u30ff]/,Korean:/[\uac00-\ud7af]/,Arabic:/[\u0600-\u06ff]/};for(const[n,a]of Object.entries(e))if(a.test(t))return n;return"English"}function be(t){const e=t.trim();if(!e)throw new Error("Empty response from AI service");const n=e.split(`
`);let a=0;for(let s=0;s<n.length;s++){const i=n[s].trim();if(i&&!i.toLowerCase().includes("translation")&&!i.toLowerCase().includes("translated")){a=s;break}}return n.slice(a).join(`
`).trim()}function Ie(t,e,n,a){let s=.5;const i=e.length/t.length;i>=.5&&i<=2&&(s+=.2);const r=t.split(/[.!?]+/).filter(h=>h.trim().length>0).length,c=e.split(/[.!?]+/).filter(h=>h.trim().length>0).length;Math.abs(r-c)<=1&&(s+=.2);const l=t.split(/\s+/).length,u=e.split(/\s+/).length/l;return u>=.7&&u<=1.5&&(s+=.1),Math.min(1,s)}function Te(t,e,n,a){let s=.5;e.length>0&&(s+=.2),a==="English"&&/[a-zA-Z]/.test(e)&&(s+=.1);const i=t.split(/\n\s*\n/).length,r=e.split(/\n\s*\n/).length;Math.abs(i-r)<=1&&(s+=.1);const c=(t.match(/[.!?]/g)||[]).length,l=(e.match(/[.!?]/g)||[]).length;return Math.abs(c-l)<=2&&(s+=.1),Math.min(1,s)}async function U(){try{await N(),await M(),chrome.runtime.onMessage.addListener(Le),o.info("Message router initialized successfully")}catch(t){throw o.error("Failed to initialize message router",t),t}}async function Le(t,e,n){var i;const a=Date.now(),s=t.requestId||$e();try{if(o.debug("Message received",{action:t.action,requestId:s,source:t.source,tabId:t.tabId,senderId:(i=e.tab)==null?void 0:i.id}),!t.action)throw new Error("Action is required");let r;const c={processingTime:Date.now()-a,timestamp:new Date().toISOString(),action:t.action};switch(t.action){case"ping":r=await Ce();break;case"summarize":r=await Ee(t.text,t.options);break;case"rewrite":r=await Oe(t.text,t.options);break;case"ideate":r=await Ae(t.text,t.options);break;case"translate":r=await Pe(t.text,t.options);break;case"getSettings":r=await Me();break;case"updateSettings":r=await Re(t.options);break;case"clearCache":r=await ke();break;default:throw new Error(`Unknown action: ${t.action}`)}const l={success:!0,data:r,requestId:s,metadata:c};return o.info("Message processed successfully",{action:t.action,requestId:s,processingTime:c.processingTime}),n(l),!0}catch(r){const c=Date.now()-a;o.error("Message processing failed",r,{action:t.action,requestId:s,processingTime:c});const l={success:!1,error:r instanceof Error?r.message:"Unknown error occurred",requestId:s,metadata:{processingTime:c,timestamp:new Date().toISOString(),action:t.action}};return n(l),!0}}async function Ce(){return{status:"pong",timestamp:new Date().toISOString()}}async function Ee(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for summarization");return await B(t,e)}async function Oe(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for rewriting");return await ne(t,e)}async function Ae(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for ideation");return await de(t,e)}async function Pe(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for translation");return await fe(t,e)}async function Me(){const{settingsManager:t}=await C(async()=>{const{settingsManager:e}=await Promise.resolve().then(()=>F);return{settingsManager:e}},void 0);return t.getSettings()}async function Re(t){const{settingsManager:e}=await C(async()=>{const{settingsManager:n}=await Promise.resolve().then(()=>F);return{settingsManager:n}},void 0);return t.user&&await e.updateUserSettings(t.user),t.providers&&await e.updateProviderSettings(t.providers),e.getSettings()}async function ke(){const{clearCache:t}=await C(async()=>{const{clearCache:e}=await Promise.resolve().then(()=>X);return{clearCache:e}},void 0);return await t(),{message:"Cache cleared successfully"}}function $e(){return`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async function xe(t,e){try{const n=await chrome.tabs.sendMessage(t,e);return o.debug("Message sent to content script",{tabId:t,messageType:e.type}),n}catch(n){throw o.error("Failed to send message to content script",n,{tabId:t}),n}}function Fe(){chrome.tabs.onUpdated.addListener((t,e,n)=>{e.status==="complete"&&n.url&&(o.debug("Tab updated",{tabId:t,url:n.url}),xe(t,{type:"tabUpdated",url:n.url,timestamp:new Date().toISOString()}).catch(a=>{o.debug("Failed to notify content script of tab update",{tabId:t,error:a.message})}))})}function Ue(){chrome.runtime.onInstalled.addListener(t=>{o.info("Extension installed/updated",{reason:t.reason,previousVersion:t.previousVersion}),t.reason==="install"&&M().catch(e=>{o.error("Failed to initialize settings on install",e)})})}function De(){chrome.runtime.onStartup.addListener(()=>{o.info("Extension started"),U().catch(t=>{o.error("Failed to reinitialize message router on startup",t)})})}function ze(){Fe(),Ue(),De()}async function _e(){try{await U(),ze(),o.info("MuseFlow backend initialized successfully")}catch(t){throw o.error("Failed to initialize MuseFlow backend",t),t}}_e().catch(t=>{console.error("MuseFlow: Failed to initialize backend:",t)});chrome.runtime.onMessage.addListener((t,e,n)=>t.type==="CONTEXT_CAPTURED"?(D(t.data),!0):t.action&&["summarize","rewrite","ideate","translate"].includes(t.action)?(je(t,e,n),!0):!1);async function D(t){var e;try{console.log("MuseFlow: Processing context capture:",t);const n="summarize",a=await chrome.runtime.sendMessage({action:n,text:t.selectedText,options:{}});if(a.success){const s={type:"AI_RESPONSE",response:a.data.summary||a.data.rewrittenText||((e=a.data.ideas)==null?void 0:e.map(i=>i.title).join(`
`))||a.data.translatedText||"No response",action:n};chrome.tabs.query({},i=>{i.forEach(r=>{r.id&&chrome.tabs.sendMessage(r.id,s).catch(()=>{})})})}}catch(n){console.error("MuseFlow: Error processing context:",n)}}async function je(t,e,n){try{const a=await chrome.runtime.sendMessage(t);n(a)}catch(a){console.error("MuseFlow: Error handling AI action:",a),n({success:!1,error:a instanceof Error?a.message:"Unknown error"})}}chrome.runtime.onInstalled.addListener(t=>{console.log("MuseFlow: Extension installed/updated:",t.reason),chrome.contextMenus.create({id:"museflow-ai",title:"Process with MuseFlow AI",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener((t,e)=>{if(t.menuItemId==="museflow-ai"&&t.selectionText){const n={data:{selectedText:t.selectionText,title:(e==null?void 0:e.title)||"Unknown",url:(e==null?void 0:e.url)||"Unknown",snippet:t.selectionText.substring(0,200)+(t.selectionText.length>200?"...":""),timestamp:Date.now()}};D(n.data)}});chrome.runtime.onInstalled.addListener(t=>{t.reason==="install"&&(chrome.contextMenus.create({id:"museflow-summarize",title:"Summarize with MuseFlow",contexts:["selection"],parentId:"museflow-ai"}),chrome.contextMenus.create({id:"museflow-rewrite",title:"Rewrite with MuseFlow",contexts:["selection"],parentId:"museflow-ai"}),chrome.contextMenus.create({id:"museflow-ideate",title:"Generate Ideas with MuseFlow",contexts:["selection"],parentId:"museflow-ai"}),chrome.contextMenus.create({id:"museflow-translate",title:"Translate with MuseFlow",contexts:["selection"],parentId:"museflow-ai"}))});chrome.contextMenus.onClicked.addListener((t,e)=>{var n;if(t.selectionText&&((n=t.menuItemId)!=null&&n.toString().startsWith("museflow-"))){const a=t.menuItemId.toString().replace("museflow-","");chrome.runtime.sendMessage({action:a,text:t.selectionText,options:{}}).then(s=>{var i;s.success&&(e!=null&&e.id)&&chrome.tabs.sendMessage(e.id,{type:"AI_RESPONSE",response:s.data.summary||s.data.rewrittenText||((i=s.data.ideas)==null?void 0:i.map(r=>r.title).join(`
`))||s.data.translatedText||"No response",action:a})}).catch(s=>{console.error("MuseFlow: Error processing context menu action:",s)})}});
