var _=Object.defineProperty;var j=(t,e,n)=>e in t?_(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var p=(t,e,n)=>j(t,typeof e!="symbol"?e+"":e,n);const N="modulepreload",W=function(t){return"/"+t},M={},C=function(e,n,a){let s=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),c=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));s=Promise.allSettled(n.map(l=>{if(l=W(l),l in M)return;M[l]=!0;const g=l.endsWith(".css"),d=g?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${d}`))return;const u=document.createElement("link");if(u.rel=g?"stylesheet":N,g||(u.as="script"),u.crossOrigin="",u.href=l,c&&u.setAttribute("nonce",c),document.head.appendChild(u),g)return new Promise((h,m)=>{u.addEventListener("load",h),u.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${l}`)))})}))}function r(i){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=i,window.dispatchEvent(c),!c.defaultPrevented)throw i}return s.then(i=>{for(const c of i||[])c.status==="rejected"&&r(c.reason);return e().catch(r)})};var E=(t=>(t[t.DEBUG=0]="DEBUG",t[t.INFO=1]="INFO",t[t.WARN=2]="WARN",t[t.ERROR=3]="ERROR",t))(E||{});class K{constructor(){p(this,"currentLevel",1);p(this,"logs",[]);p(this,"maxLogs",1e3)}setLevel(e){this.currentLevel=e}getLevel(){return this.currentLevel}debug(e,n){this.log(0,e,n)}info(e,n){this.log(1,e,n)}warn(e,n){this.log(2,e,n)}error(e,n,a){this.log(3,e,{...a,error:n})}log(e,n,a){if(e<this.currentLevel)return;const s={timestamp:new Date().toISOString(),level:e,message:n,context:a};this.logs.push(s),this.logs.length>this.maxLogs&&this.logs.shift();const r=this.formatMessage(s);switch(e){case 0:console.debug(r,a);break;case 1:console.info(r,a);break;case 2:console.warn(r,a);break;case 3:console.error(r,a);break}e>=2&&this.storeInChromeStorage(s)}formatMessage(e){const n=E[e.level];return`[${new Date(e.timestamp).toLocaleTimeString()}] [${n}] ${e.message}`}async storeInChromeStorage(e){try{const a=(await chrome.storage.local.get(["logs"])).logs||[];a.push(e),a.length>50&&a.splice(0,a.length-50),await chrome.storage.local.set({logs:a})}catch(n){console.error("Failed to store log in Chrome storage:",n)}}getLogs(e=100){return this.logs.slice(-e)}clearLogs(){this.logs=[]}async getStoredLogs(){try{return(await chrome.storage.local.get(["logs"])).logs||[]}catch(e){return console.error("Failed to get stored logs:",e),[]}}async clearStoredLogs(){try{await chrome.storage.local.remove(["logs"])}catch(e){console.error("Failed to clear stored logs:",e)}}}const o=new K;async function H(){try{const t=await chrome.storage.sync.get(["logLevel"]);t.logLevel!==void 0&&o.setLevel(t.logLevel),o.info("Logging initialized",{level:E[o.getLevel()],timestamp:new Date().toISOString()})}catch(t){console.error("Failed to initialize logging:",t)}}const P={defaultLanguage:"English",defaultTone:"professional",defaultSummaryLength:"medium",preferredProvider:"chrome",autoCache:!0,showDebugInfo:!1,keyboardShortcuts:!0,popupPosition:"top",theme:"auto",animations:!0,soundEffects:!1,autoExpandPopup:!1,contextWindowSize:1e3},O={requestTimeout:3e4,maxRetries:3,rateLimit:{requestsPerMinute:60,requestsPerHour:1e3}},w={user:P,providers:O,lastUpdated:Date.now(),version:"1.0.0"};class G{constructor(){p(this,"settings",w);p(this,"isInitialized",!1)}async initialize(){try{const e=await chrome.storage.sync.get(["appSettings"]);e.appSettings?(this.settings={...w,...e.appSettings},o.debug("Settings loaded from storage",{version:this.settings.version,lastUpdated:new Date(this.settings.lastUpdated).toISOString()})):(await this.saveSettings(),o.debug("Default settings initialized")),this.isInitialized=!0}catch(e){o.error("Failed to initialize settings",e),this.settings=w,this.isInitialized=!0}}getSettings(){return{...this.settings}}getUserSettings(){return{...this.settings.user}}getProviderSettings(){return{...this.settings.providers}}async updateUserSettings(e){try{this.settings.user={...this.settings.user,...e},this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.info("User settings updated",{updates:Object.keys(e),timestamp:new Date(this.settings.lastUpdated).toISOString()})}catch(n){throw o.error("Failed to update user settings",n,{updates:e}),n}}async updateProviderSettings(e){try{this.settings.providers={...this.settings.providers,...e},this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.info("Provider settings updated",{updates:Object.keys(e),timestamp:new Date(this.settings.lastUpdated).toISOString()})}catch(n){throw o.error("Failed to update provider settings",n,{updates:e}),n}}getDefaultPromptOptions(){return{targetLanguage:this.settings.user.defaultLanguage,tone:this.settings.user.defaultTone,summaryLength:this.settings.user.defaultSummaryLength}}async resetSettings(){try{this.settings={...w},await this.saveSettings(),o.info("Settings reset to defaults")}catch(e){throw o.error("Failed to reset settings",e),e}}exportSettings(){return JSON.stringify(this.settings,null,2)}async importSettings(e){try{const n=JSON.parse(e);if(!n.user||!n.providers)throw new Error("Invalid settings format");this.settings={user:{...P,...n.user},providers:{...O,...n.providers},lastUpdated:Date.now(),version:n.version||w.version},await this.saveSettings(),o.info("Settings imported successfully",{version:this.settings.version})}catch(n){throw o.error("Failed to import settings",n),n}}async saveSettings(){try{await chrome.storage.sync.set({appSettings:this.settings}),o.debug("Settings saved to storage")}catch(e){throw o.error("Failed to save settings to storage",e),e}}isReady(){return this.isInitialized}getSettingValue(e){const n=e.split(".");let a=this.settings;for(const s of n)if(a&&typeof a=="object"&&s in a)a=a[s];else return;return a}async setSettingValue(e,n){const a=e.split("."),s=a.pop();let r=this.settings;for(const i of a)(!r[i]||typeof r[i]!="object")&&(r[i]={}),r=r[i];r[s]=n,this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.debug("Setting value updated",{path:e,value:n})}}const A=new G;async function k(){return A.initialize()}function y(){return A.getDefaultPromptOptions()}const U=Object.freeze(Object.defineProperty({__proto__:null,defaultAppSettings:w,defaultProviderSettings:O,defaultUserSettings:P,getDefaultPromptOptions:y,initializeSettings:k,settingsManager:A},Symbol.toStringTag,{value:"Module"}));var R={};const x={ai:{provider:"chrome",openai:{apiKey:R.OPENAI_API_KEY||"",model:"gpt-3.5-turbo",baseUrl:"https://api.openai.com/v1"},chrome:{model:"gemini-pro"},gemini:{apiKey:R.GEMINI_API_KEY||"",model:"gemini-pro"}},limits:{maxTextLength:5e3,maxCacheEntries:100,cacheTtl:24*60*60*1e3},features:{enableCaching:!0,enableLogging:!0,enableFallback:!0}};async function I(){try{const t=await chrome.storage.sync.get(["config"]);return{...x,...t.config}}catch(t){return console.warn("Failed to load config from storage, using defaults:",t),x}}async function T(t){const e=await I();try{if(e.ai.provider==="chrome"&&chrome.ai){o.debug("Attempting Chrome AI API call",{model:e.ai.chrome.model});const n=await V(t,e.ai.chrome.model);return o.info("Chrome AI API call successful",{provider:"chrome",model:e.ai.chrome.model,responseLength:n.text.length}),n}if(e.features.enableFallback&&e.ai.openai.apiKey){o.debug("Falling back to OpenAI API",{model:e.ai.openai.model});const n=await J(t,e.ai.openai);return o.info("OpenAI API call successful",{provider:"openai",model:e.ai.openai.model,responseLength:n.text.length}),n}if(e.features.enableFallback&&e.ai.gemini.apiKey){o.debug("Falling back to Gemini API",{model:e.ai.gemini.model});const n=await X(t,e.ai.gemini);return o.info("Gemini API call successful",{provider:"gemini",model:e.ai.gemini.model,responseLength:n.text.length}),n}throw new Error("No AI provider available")}catch(n){throw o.error("AI API call failed",n,{provider:e.ai.provider,request:{promptLength:t.prompt.length}}),n}}async function V(t,e){if(!chrome.ai)throw new Error("Chrome AI API not available");try{return{text:await new Promise(a=>{setTimeout(()=>{a(`Chrome AI response for: ${t.prompt.substring(0,100)}...`)},1e3)}),model:e,provider:"chrome",timestamp:new Date().toISOString()}}catch(n){throw new Error(`Chrome AI API call failed: ${n}`)}}async function J(t,e){var s,r,i,c;const n=await fetch(`${e.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.model,messages:[{role:"user",content:t.prompt}],max_tokens:t.maxTokens||1e3,temperature:t.temperature||.7})});if(!n.ok){const l=await n.json().catch(()=>({}));throw new Error(`OpenAI API error: ${n.status} ${((s=l.error)==null?void 0:s.message)||n.statusText}`)}const a=await n.json();return{text:((i=(r=a.choices[0])==null?void 0:r.message)==null?void 0:i.content)||"",model:e.model,provider:"openai",timestamp:new Date().toISOString(),tokensUsed:(c=a.usage)==null?void 0:c.total_tokens}}async function X(t,e){var s,r,i,c;const n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${e.model}:generateContent?key=${e.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:t.prompt}]}],generationConfig:{temperature:t.temperature||.7,maxOutputTokens:t.maxTokens||1e3}})});if(!n.ok){const l=await n.json().catch(()=>({}));throw new Error(`Gemini API error: ${n.status} ${((s=l.error)==null?void 0:s.message)||n.statusText}`)}return{text:((c=(i=(r=(await n.json()).candidates[0])==null?void 0:r.content)==null?void 0:i.parts[0])==null?void 0:c.text)||"",model:e.model,provider:"gemini",timestamp:new Date().toISOString()}}class B{constructor(){p(this,"stats",{totalEntries:0,hits:0,misses:0,hitRate:0,oldestEntry:0,newestEntry:0})}generateHash(e,n){const a=`${n}:${e}`;let s=0;for(let r=0;r<a.length;r++){const i=a.charCodeAt(r);s=(s<<5)-s+i,s=s&s}return s.toString(36)}async getCacheEntry(e,n){try{if(!(await I()).features.enableCaching)return this.stats.misses++,this.updateHitRate(),null;const s=this.generateHash(e,n),r=`cache_${s}`,c=(await chrome.storage.local.get([r]))[r];if(!c)return this.stats.misses++,this.updateHitRate(),o.debug("Cache miss",{action:n,inputHash:s}),null;const l=Date.now();return l>c.timestamp+c.ttl?(await this.removeCacheEntry(r),this.stats.misses++,this.updateHitRate(),o.debug("Cache entry expired",{action:n,inputHash:s,age:l-c.timestamp}),null):(this.stats.hits++,this.updateHitRate(),o.debug("Cache hit",{action:n,inputHash:s,age:l-c.timestamp}),c.response)}catch(a){return o.error("Failed to get cache entry",a,{action:n}),this.stats.misses++,this.updateHitRate(),null}}async saveToCache(e,n,a){try{const s=await I();if(!s.features.enableCaching)return;const r=this.generateHash(n,e),i=`cache_${r}`,c={id:i,inputText:n,response:a,timestamp:Date.now(),ttl:s.limits.cacheTtl,action:e,inputHash:r};await chrome.storage.local.set({[i]:c}),this.stats.totalEntries++,this.updateStats(),o.debug("Response cached",{action:e,inputHash:r,responseLength:a.text.length}),await this.cleanupOldEntries()}catch(s){o.error("Failed to save to cache",s,{action:e})}}async removeCacheEntry(e){try{await chrome.storage.local.remove([e]),this.stats.totalEntries=Math.max(0,this.stats.totalEntries-1),this.updateStats(),o.debug("Cache entry removed",{cacheKey:e})}catch(n){o.error("Failed to remove cache entry",n,{cacheKey:e})}}async clearCache(){try{const e=await chrome.storage.local.get(null),n=Object.keys(e).filter(a=>a.startsWith("cache_"));n.length>0&&await chrome.storage.local.remove(n),this.stats.totalEntries=0,this.stats.hits=0,this.stats.misses=0,this.stats.hitRate=0,this.updateStats(),o.info("Cache cleared",{entriesRemoved:n.length})}catch(e){o.error("Failed to clear cache",e)}}getStats(){return{...this.stats}}async getAllCacheEntries(){try{const e=await chrome.storage.local.get(null),n=[];for(const[a,s]of Object.entries(e))a.startsWith("cache_")&&s&&typeof s=="object"&&n.push(s);return n.sort((a,s)=>s.timestamp-a.timestamp)}catch(e){return o.error("Failed to get all cache entries",e),[]}}updateHitRate(){const e=this.stats.hits+this.stats.misses;this.stats.hitRate=e>0?this.stats.hits/e:0}async updateStats(){try{const e=await this.getAllCacheEntries();e.length>0?(this.stats.oldestEntry=Math.min(...e.map(n=>n.timestamp)),this.stats.newestEntry=Math.max(...e.map(n=>n.timestamp))):(this.stats.oldestEntry=0,this.stats.newestEntry=0)}catch(e){o.error("Failed to update cache stats",e)}}async cleanupOldEntries(){try{const e=await I(),n=await this.getAllCacheEntries();if(n.length<=e.limits.maxCacheEntries)return;n.sort((r,i)=>r.timestamp-i.timestamp);const a=n.slice(0,n.length-e.limits.maxCacheEntries),s=a.map(r=>r.id);await chrome.storage.local.remove(s),this.stats.totalEntries=n.length-a.length,this.updateStats(),o.info("Cache cleanup completed",{removed:a.length,remaining:this.stats.totalEntries})}catch(e){o.error("Failed to cleanup old cache entries",e)}}}const L=new B;async function v(t,e){return L.getCacheEntry(t,e)}async function S(t,e,n){return L.saveToCache(t,e,n)}async function Y(){return L.clearCache()}const Z=Object.freeze(Object.defineProperty({__proto__:null,cacheManager:L,clearCache:Y,getCachedResponse:v,saveToCache:S},Symbol.toStringTag,{value:"Module"}));async function Q(t,e={}){const n=Date.now();try{o.info("Starting summarization",{textLength:t.length,options:Object.keys(e)});const a=`summarize:${JSON.stringify(e)}:${t.substring(0,100)}`,s=await v(a,"summarize");if(s)return o.debug("Using cached summarization response"),{summary:s.text,metadata:{originalLength:t.length,summaryLength:s.text.length,compressionRatio:s.text.length/t.length,processingTime:Date.now()-n}};const i={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=t.substring(0,5e3)+"...");const l={prompt:q(t,i),maxTokens:te(i.summaryLength||"medium"),temperature:.3},g=await T(l),d=ne(g.text,i),u=Date.now()-n,h={...d,metadata:{originalLength:t.length,summaryLength:d.summary.length,compressionRatio:d.summary.length/t.length,processingTime:u}};return await S("summarize",a,g),o.info("Summarization completed",{originalLength:h.metadata.originalLength,summaryLength:h.metadata.summaryLength,compressionRatio:h.metadata.compressionRatio,processingTime:h.metadata.processingTime}),h}catch(a){throw o.error("Summarization failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function q(t,e){const n=ee(e.summaryLength||"medium"),a=e.includeKeyPoints?" Also provide key points as a bulleted list.":"",s=e.focusAreas&&e.focusAreas.length>0?` Focus specifically on: ${e.focusAreas.join(", ")}.`:"";return`Summarize the following text clearly and concisely.

INSTRUCTIONS:
${n}${a}${s}
Focus on the main points and key information while maintaining accuracy and clarity.
Remove redundant information and present the core message effectively.

TEXT TO SUMMARIZE:
${t}

Please provide a well-structured summary that captures the essential information.`}function ee(t){switch(t){case"short":return"Provide a concise summary (1-2 sentences).";case"long":return"Provide a comprehensive summary with key details and context.";case"medium":default:return"Provide a balanced summary (3-5 sentences)."}}function te(t){switch(t){case"short":return 150;case"long":return 500;case"medium":default:return 300}}function ne(t,e){const n=t.trim();if(!n)throw new Error("Empty response from AI service");const a={summary:n};if(e.includeKeyPoints){const s=ae(n);s.length>0&&(a.keyPoints=s)}return a.confidence=se(n),a}function ae(t){const e=[],n=t.split(`
`);for(const a of n){const s=a.trim();if(s.startsWith("•")||s.startsWith("-")||s.startsWith("*")||s.startsWith("◦")||/^\d+\./.test(s)){const r=s.replace(/^[•\-*◦]|\d+\./,"").trim();r.length>0&&e.push(r)}}return e}function se(t){let e=.5;t.length>=50&&t.length<=1e3&&(e+=.2);const n=t.split(/[.!?]+/).filter(a=>a.trim().length>0);return n.length>=2&&n.length<=10&&(e+=.2),(t.includes("The")||t.includes("This")||t.includes("It"))&&(e+=.1),Math.min(1,e)}async function ie(t,e={}){const n=Date.now();try{o.info("Starting text rewriting",{textLength:t.length,options:Object.keys(e)});const a=`rewrite:${JSON.stringify(e)}:${t.substring(0,100)}`,s=await v(a,"rewrite");if(s)return o.debug("Using cached rewrite response"),{rewrittenText:s.text,originalText:t,changes:$(t,s.text),metadata:{originalLength:t.length,rewrittenLength:s.text.length,processingTime:Date.now()-n}};const i={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=t.substring(0,5e3)+"...");const l={prompt:re(t,i),maxTokens:Math.min(t.length*1.5,2e3),temperature:.4},g=await T(l),d=ue(g.text),u=$(t,d),h=Date.now()-n,m={rewrittenText:d,originalText:t,changes:u,confidence:he(t,d,i),metadata:{originalLength:t.length,rewrittenLength:d.length,processingTime:h}};return await S("rewrite",a,g),o.info("Text rewriting completed",{originalLength:m.metadata.originalLength,rewrittenLength:m.metadata.rewrittenLength,wordCountChange:m.changes.wordCountChange,processingTime:m.metadata.processingTime}),m}catch(a){throw o.error("Text rewriting failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function re(t,e){const n=oe(e.tone||"professional"),a=ce(e.style),s=le(e.audience),r=e.improvements&&e.improvements.length>0?` Focus on these specific improvements: ${e.improvements.join(", ")}.`:"";return`Rewrite the following text to improve clarity, flow, and readability while preserving the original meaning and intent.

INSTRUCTIONS:
${n}${a}${s}${r}
Maintain the core message and key information while enhancing the writing quality.

ORIGINAL TEXT:
${t}

Please provide a rewritten version that is clearer, more engaging, and better structured.`}function oe(t){switch(t){case"formal":return"Use a formal, professional tone with sophisticated vocabulary.";case"casual":return"Use a casual, conversational tone that is friendly and approachable.";case"professional":return"Use a professional, business-appropriate tone that is clear and authoritative.";case"creative":return"Use a creative, engaging tone with vivid language and compelling narrative.";case"academic":return"Use an academic tone with precise terminology and scholarly language.";case"conversational":return"Use a conversational tone that feels natural and easy to read.";default:return"Use a clear, polished tone."}}function ce(t){if(!t)return"";const e=[];return t.activeVoice&&e.push("Use active voice whenever possible."),t.simplify&&e.push("Simplify complex sentences and use clear, straightforward language."),t.descriptive&&e.push("Add descriptive language and vivid details where appropriate."),t.clarity&&e.push("Prioritize clarity and eliminate any ambiguity."),e.length>0?` ${e.join(" ")}`:""}function le(t){if(!t)return"";switch(t){case"technical":return" Write for a technical audience familiar with specialized terminology.";case"academic":return" Write for an academic audience with scholarly expectations.";case"business":return" Write for a business audience focused on results and professionalism.";case"casual":return" Write for a casual audience that prefers simple, friendly language.";case"general":default:return" Write for a general audience that values clarity and accessibility."}}function ue(t){const e=t.trim();if(!e)throw new Error("Empty response from AI service");const n=e.split(`
`);let a=0;for(let s=0;s<n.length;s++){const r=n[s].trim();if(r&&!r.toLowerCase().includes("rewritten")&&!r.toLowerCase().includes("version")){a=s;break}}return n.slice(a).join(`
`).trim()}function $(t,e){const n=t.split(/\s+/).length,a=e.split(/\s+/).length,s=t.split(/[.!?]+/).filter(i=>i.trim().length>0).length,r=e.split(/[.!?]+/).filter(i=>i.trim().length>0).length;return{wordCountChange:a-n,sentenceCountChange:r-s,readabilityScore:de(e)}}function de(t){const e=t.split(/[.!?]+/).filter(r=>r.trim().length>0).length,n=t.split(/\s+/).length,a=t.split(/\s+/).reduce((r,i)=>r+ge(i),0);if(e===0||n===0)return 0;const s=206.835-1.015*(n/e)-84.6*(a/n);return Math.max(0,Math.min(100,s))}function ge(t){const e=t.toLowerCase().replace(/[^a-z]/g,"");if(e.length===0)return 0;const n="aeiouy";let a=0,s=!1;for(let r=0;r<e.length;r++){const i=n.includes(e[r]);i&&!s&&a++,s=i}return e.endsWith("e")&&a>1&&a--,Math.max(1,a)}function he(t,e,n){let a=.5;const s=e.length/t.length;s>=.7&&s<=1.5&&(a+=.2);const r=t.split(/[.!?]+/).filter(c=>c.trim().length>0).length,i=e.split(/[.!?]+/).filter(c=>c.trim().length>0).length;return i>0&&i<=r*1.5&&(a+=.2),n.tone&&me(n.tone).filter(g=>e.toLowerCase().includes(g.toLowerCase())).length>0&&(a+=.1),Math.min(1,a)}function me(t){switch(t){case"formal":return["therefore","furthermore","consequently","moreover"];case"casual":return["actually","really","pretty","kind of"];case"professional":return["recommend","suggest","propose","indicate"];case"creative":return["imagine","picture","envision","visualize"];default:return[]}}async function pe(t,e={}){const n=Date.now();try{o.info("Starting ideation",{textLength:t.length,options:Object.keys(e)});const a=`ideate:${JSON.stringify(e)}:${t.substring(0,100)}`,s=await v(a,"ideate");if(s){o.debug("Using cached ideation response");const b=F(s.text);return{ideas:b,context:{originalText:t,domain:e.domain,focusAreas:e.focusAreas,constraints:e.constraints},metadata:{ideaCount:b.length,processingTime:Date.now()-n}}}const i={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=t.substring(0,5e3)+"...");const l={prompt:fe(t,i),maxTokens:1500,temperature:.8},g=await T(l),d=F(g.text),u=Date.now()-n,h=ye(d),m={ideas:d,context:{originalText:t,domain:e.domain,focusAreas:e.focusAreas,constraints:e.constraints},metadata:{ideaCount:d.length,processingTime:u,creativityScore:h}};return await S("ideate",a,g),o.info("Ideation completed",{ideaCount:m.metadata.ideaCount,creativityScore:m.metadata.creativityScore,processingTime:m.metadata.processingTime}),m}catch(a){throw o.error("Ideation failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function fe(t,e){const n=e.ideaCount||5,a=we(e.ideaType||"mixed"),s=e.domain?` Focus on ideas relevant to the ${e.domain} domain.`:"",r=e.focusAreas&&e.focusAreas.length>0?` Pay special attention to: ${e.focusAreas.join(", ")}.`:"",i=e.constraints&&e.constraints.length>0?` Consider these constraints: ${e.constraints.join(", ")}.`:"",c=e.audience?` Tailor ideas for a ${e.audience} audience.`:"",l=e.timeframe?` Focus on ${e.timeframe}-term implementation ideas.`:"";return`Generate creative, innovative ideas based on the following text. Think outside the box and provide practical, actionable insights.

INSTRUCTIONS:
Generate ${n} distinct ideas.${a}${s}${r}${i}${c}${l}
Each idea should be specific, actionable, and build upon the content provided.

SOURCE TEXT:
${t}

For each idea, provide:
1. A clear, compelling title
2. A detailed description explaining the concept
3. Implementation steps or approach
4. Potential benefits
5. Potential challenges
6. Effort level (low/medium/high)
7. Impact level (low/medium/high)

Please format your response clearly with numbered ideas and organized sections.`}function we(t){switch(t){case"creative":return" Focus on highly creative, innovative, and out-of-the-box ideas.";case"practical":return" Focus on practical, implementable ideas with clear benefits.";case"strategic":return" Focus on strategic, long-term thinking and planning ideas.";case"innovative":return" Focus on breakthrough innovations and novel approaches.";case"mixed":default:return" Provide a mix of creative, practical, and strategic ideas."}}function F(t){const e=[],n=t.split(`
`);let a={},s="";for(let r=0;r<n.length;r++){const i=n[r].trim();if(i){if(/^\d+\./.test(i)||/^idea\s+\d+/i.test(i)){a.title&&e.push(a),a={title:i.replace(/^\d+\.\s*/,"").replace(/^idea\s+\d+:\s*/i,"")},s="";continue}if(i.toLowerCase().includes("description")||i.toLowerCase().includes("explanation")){s="description";continue}else if(i.toLowerCase().includes("implementation")||i.toLowerCase().includes("steps")){s="implementation";continue}else if(i.toLowerCase().includes("benefits")||i.toLowerCase().includes("advantages")){s="benefits";continue}else if(i.toLowerCase().includes("challenges")||i.toLowerCase().includes("difficulties")){s="challenges";continue}else if(i.toLowerCase().includes("effort")||i.toLowerCase().includes("difficulty")){s="effort";continue}else if(i.toLowerCase().includes("impact")||i.toLowerCase().includes("effect")){s="impact";continue}if(s==="description")a.description=(a.description||"")+" "+i;else if(s==="implementation")a.implementation||(a.implementation=[]),a.implementation.push(i.replace(/^[-•*]\s*/,""));else if(s==="benefits")a.benefits||(a.benefits=[]),a.benefits.push(i.replace(/^[-•*]\s*/,""));else if(s==="challenges")a.challenges||(a.challenges=[]),a.challenges.push(i.replace(/^[-•*]\s*/,""));else if(s==="effort"){const c=i.toLowerCase();c.includes("low")?a.effortLevel="low":c.includes("high")?a.effortLevel="high":a.effortLevel="medium"}else if(s==="impact"){const c=i.toLowerCase();c.includes("low")?a.impactLevel="low":c.includes("high")?a.impactLevel="high":a.impactLevel="medium"}}}return a.title&&e.push(a),e.map(r=>{var i,c;return{...r,title:((i=r.title)==null?void 0:i.trim())||"Untitled Idea",description:((c=r.description)==null?void 0:c.trim())||"No description provided",implementation:r.implementation||[],benefits:r.benefits||[],challenges:r.challenges||[],effortLevel:r.effortLevel||"medium",impactLevel:r.impactLevel||"medium"}})}function ye(t){if(t.length===0)return 0;let e=0,n=t.length;for(const a of t){let s=.2;a.title&&a.title.length>10&&(s+=.1),a.description&&a.description.length>50&&(s+=.2),a.implementation&&a.implementation.length>0&&(s+=.2),a.benefits&&a.benefits.length>0&&(s+=.1),a.challenges&&a.challenges.length>0&&(s+=.1),a.effortLevel&&a.impactLevel&&(s+=.1),e+=s}return Math.min(1,e/n)}async function ve(t,e={}){const n=Date.now();try{o.info("Starting translation",{textLength:t.length,options:Object.keys(e)});const s={...y(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=t.substring(0,5e3)+"...");const r=s.sourceLanguage||await Te(t),i=s.targetLanguage||"English",c=`translate:${r}:${i}:${JSON.stringify(s)}:${t.substring(0,100)}`,l=await v(c,"translate");if(l)return o.debug("Using cached translation response"),{translatedText:l.text,originalText:t,sourceLanguage:r,targetLanguage:i,metadata:{originalLength:t.length,translatedLength:l.text.length,processingTime:Date.now()-n}};const d={prompt:Se(t,r,i,s),maxTokens:Math.min(t.length*2,3e3),temperature:.3},u=await T(d),h=Le(u.text),m=Date.now()-n,b=Ee(t,h,r,i),f={translatedText:h,originalText:t,sourceLanguage:r,targetLanguage:i,confidence:Ce(t,h,r,i),metadata:{originalLength:t.length,translatedLength:h.length,processingTime:m,qualityScore:b}};return await S("translate",c,u),o.info("Translation completed",{sourceLanguage:f.sourceLanguage,targetLanguage:f.targetLanguage,originalLength:f.metadata.originalLength,translatedLength:f.metadata.translatedLength,processingTime:f.metadata.processingTime}),f}catch(a){throw o.error("Translation failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function Se(t,e,n,a){const s=be(a.style),r=Ie(a.domain),i=a.culturalAdaptation?" Adapt cultural references and idioms appropriately for the target language and culture.":"",c=a.preserveFormatting?" Preserve all formatting, including line breaks, punctuation, and special characters.":"";return`Translate the following text from ${e} to ${n}.

INSTRUCTIONS:
${s}${r}${i}${c}
Maintain the original meaning, tone, and context while ensuring the translation reads naturally in ${n}.
Preserve any technical terms, proper nouns, or specialized vocabulary appropriately.

TEXT TO TRANSLATE:
${t}

Please provide an accurate, natural-sounding translation in ${n}.`}function be(t){switch(t){case"formal":return"Use formal language and register appropriate for official or academic contexts.";case"informal":return"Use informal, conversational language that sounds natural and casual.";case"technical":return"Use precise technical terminology and maintain technical accuracy.";case"literary":return"Preserve literary style, metaphors, and artistic expression.";case"conversational":return"Use conversational tone that feels natural and easy to read.";default:return"Use clear, natural language appropriate for general communication."}}function Ie(t){switch(t){case"business":return"Use business-appropriate language and terminology.";case"technical":return"Maintain technical accuracy and use precise technical terminology.";case"medical":return"Use accurate medical terminology and maintain clinical precision.";case"legal":return"Use precise legal terminology and maintain legal accuracy.";case"academic":return"Use scholarly language and maintain academic rigor.";default:return""}}async function Te(t){const e={English:/^(the|and|or|but|in|on|at|to|for|of|with|by)\s/i,Spanish:/^(el|la|los|las|un|una|de|del|en|con|por|para)\s/i,French:/^(le|la|les|un|une|de|du|des|en|avec|pour|par)\s/i,German:/^(der|die|das|ein|eine|und|oder|aber|in|auf|mit|für)\s/i,Italian:/^(il|la|lo|gli|le|un|una|di|del|della|in|con|per)\s/i,Portuguese:/^(o|a|os|as|um|uma|de|do|da|em|com|para)\s/i,Russian:/^[а-яё]/i,Chinese:/[\u4e00-\u9fff]/,Japanese:/[\u3040-\u309f\u30a0-\u30ff]/,Korean:/[\uac00-\ud7af]/,Arabic:/[\u0600-\u06ff]/};for(const[n,a]of Object.entries(e))if(a.test(t))return n;return"English"}function Le(t){const e=t.trim();if(!e)throw new Error("Empty response from AI service");const n=e.split(`
`);let a=0;for(let s=0;s<n.length;s++){const r=n[s].trim();if(r&&!r.toLowerCase().includes("translation")&&!r.toLowerCase().includes("translated")){a=s;break}}return n.slice(a).join(`
`).trim()}function Ce(t,e,n,a){let s=.5;const r=e.length/t.length;r>=.5&&r<=2&&(s+=.2);const i=t.split(/[.!?]+/).filter(u=>u.trim().length>0).length,c=e.split(/[.!?]+/).filter(u=>u.trim().length>0).length;Math.abs(i-c)<=1&&(s+=.2);const l=t.split(/\s+/).length,d=e.split(/\s+/).length/l;return d>=.7&&d<=1.5&&(s+=.1),Math.min(1,s)}function Ee(t,e,n,a){let s=.5;e.length>0&&(s+=.2),a==="English"&&/[a-zA-Z]/.test(e)&&(s+=.1);const r=t.split(/\n\s*\n/).length,i=e.split(/\n\s*\n/).length;Math.abs(r-i)<=1&&(s+=.1);const c=(t.match(/[.!?]/g)||[]).length,l=(e.match(/[.!?]/g)||[]).length;return Math.abs(c-l)<=2&&(s+=.1),Math.min(1,s)}async function D(){try{await H(),await k(),chrome.runtime.onMessage.addListener(Pe),o.info("Message router initialized successfully")}catch(t){throw o.error("Failed to initialize message router",t),t}}async function Pe(t,e,n){var r;const a=Date.now(),s=t.requestId||Ue();try{if(o.debug("Message received",{action:t.action,requestId:s,source:t.source,tabId:t.tabId,senderId:(r=e.tab)==null?void 0:r.id}),!t.action)throw new Error("Action is required");let i;const c={processingTime:Date.now()-a,timestamp:new Date().toISOString(),action:t.action};switch(t.action){case"ping":i=await Oe();break;case"summarize":i=await Ae(t.text,t.options);break;case"rewrite":i=await ke(t.text,t.options);break;case"ideate":i=await Me(t.text,t.options);break;case"translate":i=await Re(t.text,t.options);break;case"getSettings":i=await xe();break;case"updateSettings":i=await $e(t.options);break;case"clearCache":i=await Fe();break;default:throw new Error(`Unknown action: ${t.action}`)}const l={success:!0,data:i,requestId:s,metadata:c};return o.info("Message processed successfully",{action:t.action,requestId:s,processingTime:c.processingTime}),n(l),!0}catch(i){const c=Date.now()-a;o.error("Message processing failed",i,{action:t.action,requestId:s,processingTime:c});const l={success:!1,error:i instanceof Error?i.message:"Unknown error occurred",requestId:s,metadata:{processingTime:c,timestamp:new Date().toISOString(),action:t.action}};return n(l),!0}}async function Oe(){return{status:"pong",timestamp:new Date().toISOString()}}async function Ae(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for summarization");return await Q(t,e)}async function ke(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for rewriting");return await ie(t,e)}async function Me(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for ideation");return await pe(t,e)}async function Re(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for translation");return await ve(t,e)}async function xe(){const{settingsManager:t}=await C(async()=>{const{settingsManager:e}=await Promise.resolve().then(()=>U);return{settingsManager:e}},void 0);return t.getSettings()}async function $e(t){const{settingsManager:e}=await C(async()=>{const{settingsManager:n}=await Promise.resolve().then(()=>U);return{settingsManager:n}},void 0);return t.user&&await e.updateUserSettings(t.user),t.providers&&await e.updateProviderSettings(t.providers),e.getSettings()}async function Fe(){const{clearCache:t}=await C(async()=>{const{clearCache:e}=await Promise.resolve().then(()=>Z);return{clearCache:e}},void 0);return await t(),{message:"Cache cleared successfully"}}function Ue(){return`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async function De(t,e){try{const n=await chrome.tabs.sendMessage(t,e);return o.debug("Message sent to content script",{tabId:t,messageType:e.type}),n}catch(n){throw o.error("Failed to send message to content script",n,{tabId:t}),n}}function ze(){chrome.tabs.onUpdated.addListener((t,e,n)=>{e.status==="complete"&&n.url&&(o.debug("Tab updated",{tabId:t,url:n.url}),De(t,{type:"tabUpdated",url:n.url,timestamp:new Date().toISOString()}).catch(a=>{o.debug("Failed to notify content script of tab update",{tabId:t,error:a.message})}))})}function _e(){chrome.runtime.onInstalled.addListener(t=>{o.info("Extension installed/updated",{reason:t.reason,previousVersion:t.previousVersion}),t.reason==="install"&&k().catch(e=>{o.error("Failed to initialize settings on install",e)})})}function je(){chrome.runtime.onStartup.addListener(()=>{o.info("Extension started"),D().catch(t=>{o.error("Failed to reinitialize message router on startup",t)})})}function Ne(){ze(),_e(),je()}async function We(){try{await D(),Ne(),o.info("MuseFlow backend initialized successfully")}catch(t){throw o.error("Failed to initialize MuseFlow backend",t),t}}We().catch(t=>{console.error("MuseFlow: Failed to initialize backend:",t)});chrome.runtime.onMessage.addListener((t,e,n)=>t.type==="CONTEXT_CAPTURED"?(z(t.data),!0):t.type==="PROCESS_TEXT"?(Ke(t.data,n),!0):t.action&&["summarize","rewrite","ideate","translate"].includes(t.action)?(He(t,e,n),!0):!1);async function Ke(t,e){try{console.log("MuseFlow: Processing text from popup:",t);const n=await chrome.runtime.sendMessage({action:t.operation,text:t.text,options:t.options||{}});n.success?e({response:n.data}):e({error:n.error||"Failed to process text"})}catch(n){console.error("MuseFlow: Error processing text:",n),e({error:"Failed to process text"})}}async function z(t){var e;try{console.log("MuseFlow: Processing context capture:",t);const n="summarize",a=await chrome.runtime.sendMessage({action:n,text:t.selectedText,options:{}});if(a.success){const s={type:"AI_RESPONSE",response:a.data.summary||a.data.rewrittenText||((e=a.data.ideas)==null?void 0:e.map(r=>r.title).join(`
`))||a.data.translatedText||"No response",action:n};chrome.tabs.query({},r=>{r.forEach(i=>{i.id&&chrome.tabs.sendMessage(i.id,s).catch(()=>{})})})}}catch(n){console.error("MuseFlow: Error processing context:",n)}}async function He(t,e,n){try{const a=await chrome.runtime.sendMessage(t);n(a)}catch(a){console.error("MuseFlow: Error handling AI action:",a),n({success:!1,error:a instanceof Error?a.message:"Unknown error"})}}chrome.runtime.onInstalled.addListener(t=>{console.log("MuseFlow: Extension installed/updated:",t.reason),chrome.contextMenus.create({id:"museflow-ai",title:"Process with MuseFlow AI",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener((t,e)=>{if(t.menuItemId==="museflow-ai"&&t.selectionText){const n={data:{selectedText:t.selectionText,title:(e==null?void 0:e.title)||"Unknown",url:(e==null?void 0:e.url)||"Unknown",snippet:t.selectionText.substring(0,200)+(t.selectionText.length>200?"...":""),timestamp:Date.now()}};z(n.data)}});chrome.runtime.onInstalled.addListener(t=>{t.reason==="install"&&(chrome.contextMenus.create({id:"museflow-summarize",title:"Summarize with MuseFlow",contexts:["selection"],parentId:"museflow-ai"}),chrome.contextMenus.create({id:"museflow-rewrite",title:"Rewrite with MuseFlow",contexts:["selection"],parentId:"museflow-ai"}),chrome.contextMenus.create({id:"museflow-ideate",title:"Generate Ideas with MuseFlow",contexts:["selection"],parentId:"museflow-ai"}),chrome.contextMenus.create({id:"museflow-translate",title:"Translate with MuseFlow",contexts:["selection"],parentId:"museflow-ai"}))});chrome.contextMenus.onClicked.addListener((t,e)=>{var n;if(t.selectionText&&((n=t.menuItemId)!=null&&n.toString().startsWith("museflow-"))){const a=t.menuItemId.toString().replace("museflow-","");chrome.runtime.sendMessage({action:a,text:t.selectionText,options:{}}).then(s=>{var r;s.success&&(e!=null&&e.id)&&chrome.tabs.sendMessage(e.id,{type:"AI_RESPONSE",response:s.data.summary||s.data.rewrittenText||((r=s.data.ideas)==null?void 0:r.map(i=>i.title).join(`
`))||s.data.translatedText||"No response",action:a})}).catch(s=>{console.error("MuseFlow: Error processing context menu action:",s)})}});
