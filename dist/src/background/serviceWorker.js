var H=Object.defineProperty;var V=(t,e,n)=>e in t?H(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var f=(t,e,n)=>V(t,typeof e!="symbol"?e+"":e,n);const B="modulepreload",J=function(t){return"/"+t},P={},C=function(e,n,a){let r=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),c=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));r=Promise.allSettled(n.map(l=>{if(l=J(l),l in P)return;P[l]=!0;const u=l.endsWith(".css"),g=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${g}`))return;const m=document.createElement("link");if(m.rel=u?"stylesheet":B,u||(m.as="script"),m.crossOrigin="",m.href=l,c&&m.setAttribute("nonce",c),document.head.appendChild(m),u)return new Promise((h,d)=>{m.addEventListener("load",h),m.addEventListener("error",()=>d(new Error(`Unable to preload CSS for ${l}`)))})}))}function s(i){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=i,window.dispatchEvent(c),!c.defaultPrevented)throw i}return r.then(i=>{for(const c of i||[])c.status==="rejected"&&s(c.reason);return e().catch(s)})};var M=(t=>(t[t.DEBUG=0]="DEBUG",t[t.INFO=1]="INFO",t[t.WARN=2]="WARN",t[t.ERROR=3]="ERROR",t))(M||{});class X{constructor(){f(this,"currentLevel",1);f(this,"logs",[]);f(this,"maxLogs",1e3)}setLevel(e){this.currentLevel=e}getLevel(){return this.currentLevel}debug(e,n){this.log(0,e,n)}info(e,n){this.log(1,e,n)}warn(e,n){this.log(2,e,n)}error(e,n,a){this.log(3,e,{...a,error:n})}log(e,n,a){if(e<this.currentLevel)return;const r={timestamp:new Date().toISOString(),level:e,message:n,context:a};this.logs.push(r),this.logs.length>this.maxLogs&&this.logs.shift();const s=this.formatMessage(r);switch(e){case 0:console.debug(s,a);break;case 1:console.info(s,a);break;case 2:console.warn(s,a);break;case 3:console.error(s,a);break}e>=2&&this.storeInChromeStorage(r)}formatMessage(e){const n=M[e.level];return`[${new Date(e.timestamp).toLocaleTimeString()}] [${n}] ${e.message}`}async storeInChromeStorage(e){try{const a=(await chrome.storage.local.get(["logs"])).logs||[];a.push(e),a.length>50&&a.splice(0,a.length-50),await chrome.storage.local.set({logs:a})}catch(n){console.error("Failed to store log in Chrome storage:",n)}}getLogs(e=100){return this.logs.slice(-e)}clearLogs(){this.logs=[]}async getStoredLogs(){try{return(await chrome.storage.local.get(["logs"])).logs||[]}catch(e){return console.error("Failed to get stored logs:",e),[]}}async clearStoredLogs(){try{await chrome.storage.local.remove(["logs"])}catch(e){console.error("Failed to clear stored logs:",e)}}}const o=new X;async function D(){try{const t=await chrome.storage.sync.get(["logLevel"]);t.logLevel!==void 0&&o.setLevel(t.logLevel),console.info("[MuseFlow] Logger initialized"),o.info("Logging initialized",{level:M[o.getLevel()],timestamp:new Date().toISOString()})}catch(t){console.error("Failed to initialize logging:",t)}}const p=(...t)=>{const e=t.join(" ");console.info("[MuseFlow][INFO]",e),o.info(e)},O=(...t)=>{const e=t.join(" ");console.warn("[MuseFlow][WARN]",e),o.warn(e)},Y=(...t)=>{const e=t.join(" ");console.error("[MuseFlow][ERROR]",e),o.error(e)},L={defaultLanguage:"English",defaultTone:"professional",defaultSummaryLength:"medium",preferredProvider:"chrome",autoCache:!0,showDebugInfo:!1,keyboardShortcuts:!0,popupPosition:"top",theme:"auto",animations:!0,soundEffects:!1,autoExpandPopup:!1,contextWindowSize:1e3},E={requestTimeout:3e4,maxRetries:3,rateLimit:{requestsPerMinute:60,requestsPerHour:1e3}},y={user:L,providers:E,lastUpdated:Date.now(),version:"1.0.0"};class Z{constructor(){f(this,"settings",y);f(this,"isInitialized",!1)}async initialize(){try{const e=await chrome.storage.sync.get(["appSettings"]);e.appSettings?(this.settings={...y,...e.appSettings},o.debug("Settings loaded from storage",{version:this.settings.version,lastUpdated:new Date(this.settings.lastUpdated).toISOString()})):(await this.saveSettings(),o.debug("Default settings initialized")),this.isInitialized=!0}catch(e){o.error("Failed to initialize settings",e),this.settings=y,this.isInitialized=!0}}getSettings(){return{...this.settings}}getUserSettings(){return{...this.settings.user}}getProviderSettings(){return{...this.settings.providers}}async updateUserSettings(e){try{this.settings.user={...this.settings.user,...e},this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.info("User settings updated",{updates:Object.keys(e),timestamp:new Date(this.settings.lastUpdated).toISOString()})}catch(n){throw o.error("Failed to update user settings",n,{updates:e}),n}}async updateProviderSettings(e){try{this.settings.providers={...this.settings.providers,...e},this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.info("Provider settings updated",{updates:Object.keys(e),timestamp:new Date(this.settings.lastUpdated).toISOString()})}catch(n){throw o.error("Failed to update provider settings",n,{updates:e}),n}}getDefaultPromptOptions(){return{targetLanguage:this.settings.user.defaultLanguage,tone:this.settings.user.defaultTone,summaryLength:this.settings.user.defaultSummaryLength}}async resetSettings(){try{this.settings={...y},await this.saveSettings(),o.info("Settings reset to defaults")}catch(e){throw o.error("Failed to reset settings",e),e}}exportSettings(){return JSON.stringify(this.settings,null,2)}async importSettings(e){try{const n=JSON.parse(e);if(!n.user||!n.providers)throw new Error("Invalid settings format");this.settings={user:{...L,...n.user},providers:{...E,...n.providers},lastUpdated:Date.now(),version:n.version||y.version},await this.saveSettings(),o.info("Settings imported successfully",{version:this.settings.version})}catch(n){throw o.error("Failed to import settings",n),n}}async saveSettings(){try{await chrome.storage.sync.set({appSettings:this.settings}),o.debug("Settings saved to storage")}catch(e){throw o.error("Failed to save settings to storage",e),e}}isReady(){return this.isInitialized}getSettingValue(e){const n=e.split(".");let a=this.settings;for(const r of n)if(a&&typeof a=="object"&&r in a)a=a[r];else return;return a}async setSettingValue(e,n){const a=e.split("."),r=a.pop();let s=this.settings;for(const i of a)(!s[i]||typeof s[i]!="object")&&(s[i]={}),s=s[i];s[r]=n,this.settings.lastUpdated=Date.now(),await this.saveSettings(),o.debug("Setting value updated",{path:e,value:n})}}const k=new Z;async function x(){return k.initialize()}function v(){return k.getDefaultPromptOptions()}const _=Object.freeze(Object.defineProperty({__proto__:null,defaultAppSettings:y,defaultProviderSettings:E,defaultUserSettings:L,getDefaultPromptOptions:v,initializeSettings:x,settingsManager:k},Symbol.toStringTag,{value:"Module"}));var R={};const z={ai:{provider:"chrome",openai:{apiKey:R.OPENAI_API_KEY||"",model:"gpt-3.5-turbo",baseUrl:"https://api.openai.com/v1"},chrome:{model:"gemini-pro"},gemini:{apiKey:R.GEMINI_API_KEY||"",model:"gemini-pro"}},limits:{maxTextLength:5e3,maxCacheEntries:100,cacheTtl:24*60*60*1e3},features:{enableCaching:!0,enableLogging:!0,enableFallback:!0}};async function A(){try{const t=await chrome.storage.sync.get(["config"]);return{...z,...t.config}}catch(t){return console.warn("Failed to load config from storage, using defaults:",t),z}}async function I(t){const e=await A();try{if(e.ai.provider==="chrome"&&chrome.ai){o.debug("Attempting Chrome AI API call",{model:e.ai.chrome.model});const n=await Q(t,e.ai.chrome.model);return o.info("Chrome AI API call successful",{provider:"chrome",model:e.ai.chrome.model,responseLength:n.text.length}),n}if(console.log("[MuseFlow] Chrome AI not available, trying fallback providers..."),e.features.enableFallback&&e.ai.openai.apiKey){o.debug("Falling back to OpenAI API",{model:e.ai.openai.model});const n=await q(t,e.ai.openai);return o.info("OpenAI API call successful",{provider:"openai",model:e.ai.openai.model,responseLength:n.text.length}),n}if(e.features.enableFallback&&e.ai.gemini.apiKey){o.debug("Falling back to Gemini API",{model:e.ai.gemini.model});const n=await ee(t,e.ai.gemini);return o.info("Gemini API call successful",{provider:"gemini",model:e.ai.gemini.model,responseLength:n.text.length}),n}throw new Error("No AI provider available")}catch(n){throw o.error("AI API call failed",n,{provider:e.ai.provider,request:{promptLength:t.prompt.length}}),n}}async function Q(t,e){var n;if(!chrome.ai)throw new Error("Chrome AI API not available");try{if(console.log("[MuseFlow] Using real Chrome AI API with model:",e),chrome.ai.languageModel){console.log("[MuseFlow] Creating Chrome AI language model...");const a=await chrome.ai.languageModel.create({model:e||"gemini-pro"});console.log("[MuseFlow] Model created, generating response...");const r=await a.prompt(t.prompt,{temperature:t.temperature||.7,maxTokens:t.maxTokens||500,topP:.9});return console.log("[MuseFlow] Chrome AI response received:",r.response),{text:r.response,model:e||"gemini-pro",provider:"chrome",timestamp:new Date().toISOString(),tokensUsed:(n=r.usage)==null?void 0:n.totalTokens}}if(chrome.ai.summarizer){console.log("[MuseFlow] Using Chrome AI summarizer...");const a=await chrome.ai.summarizer.summarize(t.prompt,{length:"medium",format:"paragraph"});return console.log("[MuseFlow] Chrome AI summarizer response:",a.summary),{text:a.summary,model:e||"gemini-pro",provider:"chrome",timestamp:new Date().toISOString()}}throw new Error("No Chrome AI APIs available - neither languageModel nor summarizer")}catch(a){throw console.error("[MuseFlow] Chrome AI API call failed:",a),new Error(`Chrome AI API call failed: ${a}`)}}async function q(t,e){var r,s,i,c;const n=await fetch(`${e.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.model,messages:[{role:"user",content:t.prompt}],max_tokens:t.maxTokens||1e3,temperature:t.temperature||.7})});if(!n.ok){const l=await n.json().catch(()=>({}));throw new Error(`OpenAI API error: ${n.status} ${((r=l.error)==null?void 0:r.message)||n.statusText}`)}const a=await n.json();return{text:((i=(s=a.choices[0])==null?void 0:s.message)==null?void 0:i.content)||"",model:e.model,provider:"openai",timestamp:new Date().toISOString(),tokensUsed:(c=a.usage)==null?void 0:c.total_tokens}}async function ee(t,e){var r,s,i,c;const n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${e.model}:generateContent?key=${e.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:t.prompt}]}],generationConfig:{temperature:t.temperature||.7,maxOutputTokens:t.maxTokens||1e3}})});if(!n.ok){const l=await n.json().catch(()=>({}));throw new Error(`Gemini API error: ${n.status} ${((r=l.error)==null?void 0:r.message)||n.statusText}`)}return{text:((c=(i=(s=(await n.json()).candidates[0])==null?void 0:s.content)==null?void 0:i.parts[0])==null?void 0:c.text)||"",model:e.model,provider:"gemini",timestamp:new Date().toISOString()}}async function j(t){try{return(await fetch("https://api.openai.com/v1/models",{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}})).ok}catch(e){return o.error("Failed to verify OpenAI API key",e),!1}}async function N(t){try{return(await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${t}`,{method:"GET"})).ok}catch(e){return o.error("Failed to verify Gemini API key",e),!1}}async function te(t,e){switch(t){case"openai":return await j(e);case"gemini":return await N(e);default:return!1}}async function W(t,e={}){var n;if(!chrome.ai)throw new Error("Chrome AI API not available");try{if(console.log("[MuseFlow] Using Chrome AI Summarizer API..."),chrome.ai.summarizer)return{text:(await chrome.ai.summarizer.summarize(t,{length:e.length||"medium",format:"paragraph"})).summary,model:"chrome-summarizer",provider:"chrome",timestamp:new Date().toISOString()};if(chrome.ai.languageModel){const a=await chrome.ai.languageModel.create({model:"gemini-pro"}),r=`Summarize the following text in ${e.length||"medium"} length:

${t}`,s=await a.prompt(r,{temperature:.3,maxTokens:e.length==="short"?150:e.length==="long"?500:300,topP:.9});return{text:s.response,model:"gemini-pro",provider:"chrome",timestamp:new Date().toISOString(),tokensUsed:(n=s.usage)==null?void 0:n.totalTokens}}throw new Error("No Chrome AI summarization APIs available")}catch(a){throw console.error("[MuseFlow] Chrome AI summarization failed:",a),a}}async function F(t,e={}){var n;if(!chrome.ai)throw new Error("Chrome AI API not available");try{if(console.log("[MuseFlow] Using Chrome AI Language Model API..."),chrome.ai.languageModel){const r=await(await chrome.ai.languageModel.create({model:e.model||"gemini-pro"})).prompt(t,{temperature:e.temperature||.7,maxTokens:e.maxTokens||500,topP:e.topP||.9});return{text:r.response,model:e.model||"gemini-pro",provider:"chrome",timestamp:new Date().toISOString(),tokensUsed:(n=r.usage)==null?void 0:n.totalTokens}}throw new Error("Chrome AI Language Model API not available")}catch(a){throw console.error("[MuseFlow] Chrome AI text generation failed:",a),a}}async function K(t,e,n){var a;if(!chrome.ai)throw new Error("Chrome AI API not available");try{if(console.log("[MuseFlow] Using Chrome AI for translation..."),chrome.ai.languageModel){const r=await chrome.ai.languageModel.create({model:"gemini-pro"}),s=`Translate the following text from ${n||"auto-detect"} to ${e}:

${t}`,i=await r.prompt(s,{temperature:.3,maxTokens:Math.min(t.length*2,1e3),topP:.9});return{text:i.response,model:"gemini-pro",provider:"chrome",timestamp:new Date().toISOString(),tokensUsed:(a=i.usage)==null?void 0:a.totalTokens}}throw new Error("Chrome AI Language Model API not available for translation")}catch(r){throw console.error("[MuseFlow] Chrome AI translation failed:",r),r}}const ne=Object.freeze(Object.defineProperty({__proto__:null,callChromeAI:I,callChromeAIGenerate:F,callChromeAISummarize:W,callChromeAITranslate:K,verifyGeminiKey:N,verifyKey:te,verifyOpenAIKey:j},Symbol.toStringTag,{value:"Module"}));class ae{constructor(){f(this,"stats",{totalEntries:0,hits:0,misses:0,hitRate:0,oldestEntry:0,newestEntry:0})}async generateHash(e,n,a={}){const r=`${n}:${e}:${JSON.stringify(a)}`,i=new TextEncoder().encode(r),c=await crypto.subtle.digest("SHA-256",i);return Array.from(new Uint8Array(c)).map(u=>u.toString(16).padStart(2,"0")).join("")}async getCacheEntry(e,n,a={}){try{if(!(await A()).features.enableCaching)return this.stats.misses++,this.updateHitRate(),null;const s=await this.generateHash(e,n,a),i=`cache_${s}`,l=(await chrome.storage.local.get([i]))[i];if(!l)return this.stats.misses++,this.updateHitRate(),o.debug("Cache miss",{action:n,inputHash:s}),null;const u=Date.now();return u>l.timestamp+l.ttl?(await this.removeCacheEntry(i),this.stats.misses++,this.updateHitRate(),o.debug("Cache entry expired",{action:n,inputHash:s,age:u-l.timestamp}),null):(this.stats.hits++,this.updateHitRate(),o.debug("Cache hit",{action:n,inputHash:s,age:u-l.timestamp}),l.response)}catch(r){return console.error("[MuseFlow] Cache error:",r),o.error("Failed to get cache entry",r,{action:n}),this.stats.misses++,this.updateHitRate(),null}}async saveToCache(e,n,a,r={}){try{const s=await A();if(!s.features.enableCaching)return;const i=await this.generateHash(n,e,r),c=`cache_${i}`,l={id:c,inputText:n,response:a,timestamp:Date.now(),ttl:s.limits.cacheTtl,action:e,inputHash:i};await chrome.storage.local.set({[c]:l}),this.stats.totalEntries++,this.updateStats(),o.debug("Response cached",{action:e,inputHash:i,responseLength:a.text.length}),await this.cleanupOldEntries()}catch(s){console.error("[MuseFlow] Cache save error:",s),o.error("Failed to save to cache",s,{action:e})}}async removeCacheEntry(e){try{await chrome.storage.local.remove([e]),this.stats.totalEntries=Math.max(0,this.stats.totalEntries-1),this.updateStats(),o.debug("Cache entry removed",{cacheKey:e})}catch(n){o.error("Failed to remove cache entry",n,{cacheKey:e})}}async clearCache(){try{const e=await chrome.storage.local.get(null),n=Object.keys(e).filter(a=>a.startsWith("cache_"));n.length>0&&await chrome.storage.local.remove(n),this.stats.totalEntries=0,this.stats.hits=0,this.stats.misses=0,this.stats.hitRate=0,this.updateStats(),o.info("Cache cleared",{entriesRemoved:n.length})}catch(e){o.error("Failed to clear cache",e)}}getStats(){return{...this.stats}}async getAllCacheEntries(){try{const e=await chrome.storage.local.get(null),n=[];for(const[a,r]of Object.entries(e))a.startsWith("cache_")&&r&&typeof r=="object"&&n.push(r);return n.sort((a,r)=>r.timestamp-a.timestamp)}catch(e){return o.error("Failed to get all cache entries",e),[]}}updateHitRate(){const e=this.stats.hits+this.stats.misses;this.stats.hitRate=e>0?this.stats.hits/e:0}async updateStats(){try{const e=await this.getAllCacheEntries();e.length>0?(this.stats.oldestEntry=Math.min(...e.map(n=>n.timestamp)),this.stats.newestEntry=Math.max(...e.map(n=>n.timestamp))):(this.stats.oldestEntry=0,this.stats.newestEntry=0)}catch(e){o.error("Failed to update cache stats",e)}}async cleanupOldEntries(){try{const e=await A(),n=await this.getAllCacheEntries();if(n.length<=e.limits.maxCacheEntries)return;n.sort((s,i)=>s.timestamp-i.timestamp);const a=n.slice(0,n.length-e.limits.maxCacheEntries),r=a.map(s=>s.id);await chrome.storage.local.remove(r),this.stats.totalEntries=n.length-a.length,this.updateStats(),o.info("Cache cleanup completed",{removed:a.length,remaining:this.stats.totalEntries})}catch(e){o.error("Failed to cleanup old cache entries",e)}}}const T=new ae;async function b(t,e,n={}){return T.getCacheEntry(t,e,n)}async function S(t,e,n,a={}){return T.saveToCache(t,e,n,a)}async function re(){return T.clearCache()}const ie=Object.freeze(Object.defineProperty({__proto__:null,cacheManager:T,clearCache:re,getCachedResponse:b,saveToCache:S},Symbol.toStringTag,{value:"Module"}));async function se(t,e={}){const n=Date.now();try{o.info("Starting summarization",{textLength:t.length,options:Object.keys(e)});const a=await b(t,"summarize",e);if(a)return o.debug("Using cached summarization response"),{summary:a.text,metadata:{originalLength:t.length,summaryLength:a.text.length,compressionRatio:a.text.length/t.length,processingTime:Date.now()-n}};const s={...v(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=`${t.substring(0,5e3)}...`);const c={prompt:oe(t,s),maxTokens:le(s.summaryLength||"medium"),temperature:.3};let l;try{console.log("[MuseFlow] Attempting Chrome AI summarization..."),l=await W(t,{length:s.summaryLength||"medium"}),console.log("[MuseFlow] Chrome AI summarization successful")}catch{console.log("[MuseFlow] Chrome AI summarization failed, falling back to general AI..."),l=await I(c)}const u=ue(l.text,s),g=Date.now()-n,m={...u,metadata:{originalLength:t.length,summaryLength:u.summary.length,compressionRatio:u.summary.length/t.length,processingTime:g}};return await S("summarize",t,l,e),o.info("Summarization completed",{originalLength:m.metadata.originalLength,summaryLength:m.metadata.summaryLength,compressionRatio:m.metadata.compressionRatio,processingTime:m.metadata.processingTime}),m}catch(a){throw o.error("Summarization failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function oe(t,e){const n=ce(e.summaryLength||"medium"),a=e.includeKeyPoints?" Also provide key points as a bulleted list.":"",r=e.focusAreas&&e.focusAreas.length>0?` Focus specifically on: ${e.focusAreas.join(", ")}.`:"";return`Summarize the following text clearly and concisely.

INSTRUCTIONS:
${n}${a}${r}
Focus on the main points and key information while maintaining accuracy and clarity.
Remove redundant information and present the core message effectively.

TEXT TO SUMMARIZE:
${t}

Please provide a well-structured summary that captures the essential information.`}function ce(t){switch(t){case"short":return"Provide a concise summary (1-2 sentences).";case"long":return"Provide a comprehensive summary with key details and context.";case"medium":default:return"Provide a balanced summary (3-5 sentences)."}}function le(t){switch(t){case"short":return 150;case"long":return 500;case"medium":default:return 300}}function ue(t,e){const n=t.trim();if(!n)throw new Error("Empty response from AI service");const a={summary:n};if(e.includeKeyPoints){const r=me(n);r.length>0&&(a.keyPoints=r)}return a.confidence=ge(n),a}function me(t){const e=[],n=t.split(`
`);for(const a of n){const r=a.trim();if(r.startsWith("•")||r.startsWith("-")||r.startsWith("*")||r.startsWith("◦")||/^\d+\./.test(r)){const s=r.replace(/^[•\-*◦]|\d+\./,"").trim();s.length>0&&e.push(s)}}return e}function ge(t){let e=.5;t.length>=50&&t.length<=1e3&&(e+=.2);const n=t.split(/[.!?]+/).filter(a=>a.trim().length>0);return n.length>=2&&n.length<=10&&(e+=.2),(t.includes("The")||t.includes("This")||t.includes("It"))&&(e+=.1),Math.min(1,e)}async function he(t,e={}){const n=Date.now();try{o.info("Starting text rewriting",{textLength:t.length,options:Object.keys(e)});const a=await b(t,"rewrite",e);if(a)return o.debug("Using cached rewrite response"),{rewrittenText:a.text,originalText:t,changes:$(t,a.text),metadata:{originalLength:t.length,rewrittenLength:a.text.length,processingTime:Date.now()-n}};const s={...v(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=`${t.substring(0,5e3)}...`);const i=de(t,s),c={prompt:i,maxTokens:Math.min(t.length*1.5,2e3),temperature:.4};let l;try{console.log("[MuseFlow] Attempting Chrome AI text generation for rewrite..."),l=await F(i,{temperature:.7,maxTokens:Math.min(t.length*2,1e3),topP:.9,model:"gemini-pro"}),console.log("[MuseFlow] Chrome AI rewrite successful")}catch{console.log("[MuseFlow] Chrome AI rewrite failed, falling back to general AI..."),l=await I(c)}const u=ye(l.text),g=$(t,u),m=Date.now()-n,h={rewrittenText:u,originalText:t,changes:g,confidence:be(t,u,s),metadata:{originalLength:t.length,rewrittenLength:u.length,processingTime:m}};return await S("rewrite",t,l,e),o.info("Text rewriting completed",{originalLength:h.metadata.originalLength,rewrittenLength:h.metadata.rewrittenLength,wordCountChange:h.changes.wordCountChange,processingTime:h.metadata.processingTime}),h}catch(a){throw o.error("Text rewriting failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function de(t,e){const n=pe(e.tone||"professional"),a=fe(e.style),r=we(e.audience),s=e.improvements&&e.improvements.length>0?` Focus on these specific improvements: ${e.improvements.join(", ")}.`:"";return`Rewrite the following text to improve clarity, flow, and readability while preserving the original meaning and intent.

INSTRUCTIONS:
${n}${a}${r}${s}
Maintain the core message and key information while enhancing the writing quality.

ORIGINAL TEXT:
${t}

Please provide a rewritten version that is clearer, more engaging, and better structured.`}function pe(t){switch(t){case"formal":return"Use a formal, professional tone with sophisticated vocabulary.";case"casual":return"Use a casual, conversational tone that is friendly and approachable.";case"professional":return"Use a professional, business-appropriate tone that is clear and authoritative.";case"creative":return"Use a creative, engaging tone with vivid language and compelling narrative.";case"academic":return"Use an academic tone with precise terminology and scholarly language.";case"conversational":return"Use a conversational tone that feels natural and easy to read.";default:return"Use a clear, polished tone."}}function fe(t){if(!t)return"";const e=[];return t.activeVoice&&e.push("Use active voice whenever possible."),t.simplify&&e.push("Simplify complex sentences and use clear, straightforward language."),t.descriptive&&e.push("Add descriptive language and vivid details where appropriate."),t.clarity&&e.push("Prioritize clarity and eliminate any ambiguity."),e.length>0?` ${e.join(" ")}`:""}function we(t){if(!t)return"";switch(t){case"technical":return" Write for a technical audience familiar with specialized terminology.";case"academic":return" Write for an academic audience with scholarly expectations.";case"business":return" Write for a business audience focused on results and professionalism.";case"casual":return" Write for a casual audience that prefers simple, friendly language.";case"general":default:return" Write for a general audience that values clarity and accessibility."}}function ye(t){const e=t.trim();if(!e)throw new Error("Empty response from AI service");const n=e.split(`
`);let a=0;for(let r=0;r<n.length;r++){const s=n[r].trim();if(s&&!s.toLowerCase().includes("rewritten")&&!s.toLowerCase().includes("version")){a=r;break}}return n.slice(a).join(`
`).trim()}function $(t,e){const n=t.split(/\s+/).length,a=e.split(/\s+/).length,r=t.split(/[.!?]+/).filter(i=>i.trim().length>0).length,s=e.split(/[.!?]+/).filter(i=>i.trim().length>0).length;return{wordCountChange:a-n,sentenceCountChange:s-r,readabilityScore:ve(e)}}function ve(t){const e=t.split(/[.!?]+/).filter(s=>s.trim().length>0).length,n=t.split(/\s+/).length,a=t.split(/\s+/).reduce((s,i)=>s+Ie(i),0);if(e===0||n===0)return 0;const r=206.835-1.015*(n/e)-84.6*(a/n);return Math.max(0,Math.min(100,r))}function Ie(t){const e=t.toLowerCase().replace(/[^a-z]/g,"");if(e.length===0)return 0;const n="aeiouy";let a=0,r=!1;for(let s=0;s<e.length;s++){const i=n.includes(e[s]);i&&!r&&a++,r=i}return e.endsWith("e")&&a>1&&a--,Math.max(1,a)}function be(t,e,n){let a=.5;const r=e.length/t.length;r>=.7&&r<=1.5&&(a+=.2);const s=t.split(/[.!?]+/).filter(c=>c.trim().length>0).length,i=e.split(/[.!?]+/).filter(c=>c.trim().length>0).length;return i>0&&i<=s*1.5&&(a+=.2),n.tone&&Se(n.tone).filter(u=>e.toLowerCase().includes(u.toLowerCase())).length>0&&(a+=.1),Math.min(1,a)}function Se(t){switch(t){case"formal":return["therefore","furthermore","consequently","moreover"];case"casual":return["actually","really","pretty","kind of"];case"professional":return["recommend","suggest","propose","indicate"];case"creative":return["imagine","picture","envision","visualize"];default:return[]}}async function Ae(t,e={}){const n=Date.now();try{o.info("Starting ideation",{textLength:t.length,options:Object.keys(e)});const a=await b(t,"ideate",e);if(a){o.debug("Using cached ideation response");const d=U(a.text);return{ideas:d,context:{originalText:t,domain:e.domain,focusAreas:e.focusAreas,constraints:e.constraints},metadata:{ideaCount:d.length,processingTime:Date.now()-n}}}const s={...v(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=`${t.substring(0,5e3)}...`);const i=Ce(t,s),c={prompt:i,maxTokens:1500,temperature:.8};let l;try{console.log("[MuseFlow] Attempting Chrome AI text generation for ideation..."),l=await F(i,{temperature:.8,maxTokens:Math.min(t.length*3,1500),topP:.9,model:"gemini-pro"}),console.log("[MuseFlow] Chrome AI ideation successful")}catch{console.log("[MuseFlow] Chrome AI ideation failed, falling back to general AI..."),l=await I(c)}const u=U(l.text),g=Date.now()-n,m=Me(u),h={ideas:u,context:{originalText:t,domain:e.domain,focusAreas:e.focusAreas,constraints:e.constraints},metadata:{ideaCount:u.length,processingTime:g,creativityScore:m}};return await S("ideate",t,l,e),o.info("Ideation completed",{ideaCount:h.metadata.ideaCount,creativityScore:h.metadata.creativityScore,processingTime:h.metadata.processingTime}),h}catch(a){throw o.error("Ideation failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function Ce(t,e){const n=e.ideaCount||5,a=Te(e.ideaType||"mixed"),r=e.domain?` Focus on ideas relevant to the ${e.domain} domain.`:"",s=e.focusAreas&&e.focusAreas.length>0?` Pay special attention to: ${e.focusAreas.join(", ")}.`:"",i=e.constraints&&e.constraints.length>0?` Consider these constraints: ${e.constraints.join(", ")}.`:"",c=e.audience?` Tailor ideas for a ${e.audience} audience.`:"",l=e.timeframe?` Focus on ${e.timeframe}-term implementation ideas.`:"";return`Generate creative, innovative ideas based on the following text. Think outside the box and provide practical, actionable insights.

INSTRUCTIONS:
Generate ${n} distinct ideas.${a}${r}${s}${i}${c}${l}
Each idea should be specific, actionable, and build upon the content provided.

SOURCE TEXT:
${t}

For each idea, provide:
1. A clear, compelling title
2. A detailed description explaining the concept
3. Implementation steps or approach
4. Potential benefits
5. Potential challenges
6. Effort level (low/medium/high)
7. Impact level (low/medium/high)

Please format your response clearly with numbered ideas and organized sections.`}function Te(t){switch(t){case"creative":return" Focus on highly creative, innovative, and out-of-the-box ideas.";case"practical":return" Focus on practical, implementable ideas with clear benefits.";case"strategic":return" Focus on strategic, long-term thinking and planning ideas.";case"innovative":return" Focus on breakthrough innovations and novel approaches.";case"mixed":default:return" Provide a mix of creative, practical, and strategic ideas."}}function U(t){const e=[],n=t.split(`
`);let a={},r="";for(let s=0;s<n.length;s++){const i=n[s].trim();if(i){if(/^\d+\./.test(i)||/^idea\s+\d+/i.test(i)){a.title&&e.push(a),a={title:i.replace(/^\d+\.\s*/,"").replace(/^idea\s+\d+:\s*/i,"")},r="";continue}if(i.toLowerCase().includes("description")||i.toLowerCase().includes("explanation")){r="description";continue}else if(i.toLowerCase().includes("implementation")||i.toLowerCase().includes("steps")){r="implementation";continue}else if(i.toLowerCase().includes("benefits")||i.toLowerCase().includes("advantages")){r="benefits";continue}else if(i.toLowerCase().includes("challenges")||i.toLowerCase().includes("difficulties")){r="challenges";continue}else if(i.toLowerCase().includes("effort")||i.toLowerCase().includes("difficulty")){r="effort";continue}else if(i.toLowerCase().includes("impact")||i.toLowerCase().includes("effect")){r="impact";continue}if(r==="description")a.description=`${a.description||""} ${i}`;else if(r==="implementation")a.implementation||(a.implementation=[]),a.implementation.push(i.replace(/^[-•*]\s*/,""));else if(r==="benefits")a.benefits||(a.benefits=[]),a.benefits.push(i.replace(/^[-•*]\s*/,""));else if(r==="challenges")a.challenges||(a.challenges=[]),a.challenges.push(i.replace(/^[-•*]\s*/,""));else if(r==="effort"){const c=i.toLowerCase();c.includes("low")?a.effortLevel="low":c.includes("high")?a.effortLevel="high":a.effortLevel="medium"}else if(r==="impact"){const c=i.toLowerCase();c.includes("low")?a.impactLevel="low":c.includes("high")?a.impactLevel="high":a.impactLevel="medium"}}}return a.title&&e.push(a),e.map(s=>{var i,c;return{...s,title:((i=s.title)==null?void 0:i.trim())||"Untitled Idea",description:((c=s.description)==null?void 0:c.trim())||"No description provided",implementation:s.implementation||[],benefits:s.benefits||[],challenges:s.challenges||[],effortLevel:s.effortLevel||"medium",impactLevel:s.impactLevel||"medium"}})}function Me(t){if(t.length===0)return 0;let e=0;const n=t.length;for(const a of t){let r=.2;a.title&&a.title.length>10&&(r+=.1),a.description&&a.description.length>50&&(r+=.2),a.implementation&&a.implementation.length>0&&(r+=.2),a.benefits&&a.benefits.length>0&&(r+=.1),a.challenges&&a.challenges.length>0&&(r+=.1),a.effortLevel&&a.impactLevel&&(r+=.1),e+=r}return Math.min(1,e/n)}async function Le(t,e={}){const n=Date.now();try{o.info("Starting translation",{textLength:t.length,options:Object.keys(e)});const r={...v(),...e};if(!t||t.trim().length===0)throw new Error("Input text cannot be empty");t.length>5e3&&(o.warn("Text length exceeds recommended limit, truncating..."),t=`${t.substring(0,5e3)}...`);const s=r.sourceLanguage||await Pe(t),i=r.targetLanguage||"English",c=await b(t,"translate",r);if(c)return o.debug("Using cached translation response"),{translatedText:c.text,originalText:t,sourceLanguage:s,targetLanguage:i,metadata:{originalLength:t.length,translatedLength:c.text.length,processingTime:Date.now()-n}};const u={prompt:Ee(t,s,i,r),maxTokens:Math.min(t.length*2,3e3),temperature:.3};let g;try{console.log("[MuseFlow] Attempting Chrome AI translation..."),g=await K(t,r.targetLanguage||"English",r.sourceLanguage),console.log("[MuseFlow] Chrome AI translation successful")}catch{console.log("[MuseFlow] Chrome AI translation failed, falling back to general AI..."),g=await I(u)}const m=Oe(g.text),h=Date.now()-n,d=ze(t,m,s,i),w={translatedText:m,originalText:t,sourceLanguage:s,targetLanguage:i,confidence:Re(t,m,s,i),metadata:{originalLength:t.length,translatedLength:m.length,processingTime:h,qualityScore:d}};return await S("translate",t,g,r),o.info("Translation completed",{sourceLanguage:w.sourceLanguage,targetLanguage:w.targetLanguage,originalLength:w.metadata.originalLength,translatedLength:w.metadata.translatedLength,processingTime:w.metadata.processingTime}),w}catch(a){throw o.error("Translation failed",a,{textLength:t.length,options:Object.keys(e),processingTime:Date.now()-n}),a}}function Ee(t,e,n,a){const r=ke(a.style),s=Fe(a.domain),i=a.culturalAdaptation?" Adapt cultural references and idioms appropriately for the target language and culture.":"",c=a.preserveFormatting?" Preserve all formatting, including line breaks, punctuation, and special characters.":"";return`Translate the following text from ${e} to ${n}.

INSTRUCTIONS:
${r}${s}${i}${c}
Maintain the original meaning, tone, and context while ensuring the translation reads naturally in ${n}.
Preserve any technical terms, proper nouns, or specialized vocabulary appropriately.

TEXT TO TRANSLATE:
${t}

Please provide an accurate, natural-sounding translation in ${n}.`}function ke(t){switch(t){case"formal":return"Use formal language and register appropriate for official or academic contexts.";case"informal":return"Use informal, conversational language that sounds natural and casual.";case"technical":return"Use precise technical terminology and maintain technical accuracy.";case"literary":return"Preserve literary style, metaphors, and artistic expression.";case"conversational":return"Use conversational tone that feels natural and easy to read.";default:return"Use clear, natural language appropriate for general communication."}}function Fe(t){switch(t){case"business":return"Use business-appropriate language and terminology.";case"technical":return"Maintain technical accuracy and use precise technical terminology.";case"medical":return"Use accurate medical terminology and maintain clinical precision.";case"legal":return"Use precise legal terminology and maintain legal accuracy.";case"academic":return"Use scholarly language and maintain academic rigor.";default:return""}}async function Pe(t){const e={English:/^(the|and|or|but|in|on|at|to|for|of|with|by)\s/i,Spanish:/^(el|la|los|las|un|una|de|del|en|con|por|para)\s/i,French:/^(le|la|les|un|une|de|du|des|en|avec|pour|par)\s/i,German:/^(der|die|das|ein|eine|und|oder|aber|in|auf|mit|für)\s/i,Italian:/^(il|la|lo|gli|le|un|una|di|del|della|in|con|per)\s/i,Portuguese:/^(o|a|os|as|um|uma|de|do|da|em|com|para)\s/i,Russian:/^[а-яё]/i,Chinese:/[\u4e00-\u9fff]/,Japanese:/[\u3040-\u309f\u30a0-\u30ff]/,Korean:/[\uac00-\ud7af]/,Arabic:/[\u0600-\u06ff]/};for(const[n,a]of Object.entries(e))if(a.test(t))return n;return"English"}function Oe(t){const e=t.trim();if(!e)throw new Error("Empty response from AI service");const n=e.split(`
`);let a=0;for(let r=0;r<n.length;r++){const s=n[r].trim();if(s&&!s.toLowerCase().includes("translation")&&!s.toLowerCase().includes("translated")){a=r;break}}return n.slice(a).join(`
`).trim()}function Re(t,e,n,a){let r=.5;const s=e.length/t.length;s>=.5&&s<=2&&(r+=.2);const i=t.split(/[.!?]+/).filter(m=>m.trim().length>0).length,c=e.split(/[.!?]+/).filter(m=>m.trim().length>0).length;Math.abs(i-c)<=1&&(r+=.2);const l=t.split(/\s+/).length,g=e.split(/\s+/).length/l;return g>=.7&&g<=1.5&&(r+=.1),Math.min(1,r)}function ze(t,e,n,a){let r=.5;e.length>0&&(r+=.2),a==="English"&&/[a-zA-Z]/.test(e)&&(r+=.1);const s=t.split(/\n\s*\n/).length,i=e.split(/\n\s*\n/).length;Math.abs(s-i)<=1&&(r+=.1);const c=(t.match(/[.!?]/g)||[]).length,l=(e.match(/[.!?]/g)||[]).length;return Math.abs(c-l)<=2&&(r+=.1),Math.min(1,r)}async function $e(){try{await D(),await x(),chrome.runtime.onMessage.addListener((t,e,n)=>(G(t,e,n),!0)),o.info("Message router initialized successfully")}catch(t){throw o.error("Failed to initialize message router",t),t}}async function G(t,e,n){var s;const a=Date.now(),r=t.requestId||He();try{if(console.log("[MuseFlow] Message received:",{action:t.action,requestId:r,source:t.source,tabId:t.tabId,senderId:(s=e.tab)==null?void 0:s.id}),console.log("[MuseFlow] Full request object:",t),!t.action)throw new Error("Action is required");t.type&&console.log("[MuseFlow] Ignoring legacy type field:",t.type);let i;const c={processingTime:Date.now()-a,timestamp:new Date().toISOString(),action:t.action};switch(t.action){case"ping":i=await Ue();break;case"summarize":i=await De(t.text,t.options);break;case"rewrite":i=await xe(t.text,t.options);break;case"ideate":i=await _e(t.text,t.options);break;case"translate":i=await je(t.text,t.options);break;case"verifyKey":i=await Ke(t.options);break;case"getSettings":i=await Ne();break;case"updateSettings":i=await We(t.options);break;case"clearCache":i=await Ge();break;default:throw new Error(`Unknown action: ${t.action}`)}const l={success:!0,data:i,requestId:r,metadata:c};return console.log("[MuseFlow][INFO] Received",t.action),console.log("[MuseFlow][INFO] Processed",t.action,"successfully"),console.log("[MuseFlow] Router executed action:",t.action),console.log("[MuseFlow] Response sent:",l),n(l),!0}catch(i){const c=Date.now()-a;console.error("[MuseFlow] Message processing failed:",i);const l={success:!1,error:i instanceof Error?i.message:"Unknown error occurred",requestId:r,metadata:{processingTime:c,timestamp:new Date().toISOString(),action:t.action}};return i instanceof Error&&(i.message.includes("INSUFFICIENT_CONTEXT")?l.error="INSUFFICIENT_CONTEXT: Please provide at least 10 characters of text":i.message.includes("Chrome AI API not available")?l.error="AI service unavailable: Chrome AI API not accessible":i.message.includes("No AI provider available")&&(l.error="AI service unavailable: No AI providers configured")),console.log("[MuseFlow] Error response sent:",l),n(l),!0}}async function Ue(){return{status:"pong",timestamp:new Date().toISOString()}}async function De(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for summarization");return await se(t,e)}async function xe(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for rewriting");return await he(t,e)}async function _e(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for ideation");return await Ae(t,e)}async function je(t,e={}){if(!t||t.trim().length===0)throw new Error("Text is required for translation");return await Le(t,e)}async function Ne(){const{settingsManager:t}=await C(async()=>{const{settingsManager:e}=await Promise.resolve().then(()=>_);return{settingsManager:e}},void 0);return t.getSettings()}async function We(t){const{settingsManager:e}=await C(async()=>{const{settingsManager:n}=await Promise.resolve().then(()=>_);return{settingsManager:n}},void 0);return t.user&&await e.updateUserSettings(t.user),t.providers&&await e.updateProviderSettings(t.providers),e.getSettings()}async function Ke(t){const{verifyKey:e}=await C(async()=>{const{verifyKey:a}=await Promise.resolve().then(()=>ne);return{verifyKey:a}},void 0);if(!t.provider||!t.apiKey)throw new Error("Provider and API key are required");return{valid:await e(t.provider,t.apiKey),provider:t.provider}}async function Ge(){const{clearCache:t}=await C(async()=>{const{clearCache:e}=await Promise.resolve().then(()=>ie);return{clearCache:e}},void 0);return await t(),{message:"Cache cleared successfully"}}function He(){return`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async function Ve(){try{await D(),p("Initializing backend..."),await $e(),p("Backend initialized successfully");const t=typeof chrome<"u"&&chrome.ai&&(chrome.ai.languageModel||chrome.ai.summarizer);if(p(`Chrome AI detected: ${!!t}`),t){p("Testing Chrome AI summarizer...");try{if(chrome.ai.summarizer){const e=await chrome.ai.summarizer.summarize("MuseFlow AI integration test.",{length:"short",format:"paragraph"});p("Chrome AI summarizer test successful:",e.summary)}if(chrome.ai.languageModel){const n=await(await chrome.ai.languageModel.create({model:"gemini-pro"})).prompt("Test prompt for MuseFlow integration.",{temperature:.7,maxTokens:50});p("Chrome AI language model test successful:",n.response)}p("Chrome AI integration verified - using native APIs")}catch(e){O("Chrome AI test failed, will use fallback:",e)}}else O("Chrome AI not available. Using fallback providers.");p("MuseFlow backend ready for production")}catch(t){Y("Failed to initialize MuseFlow backend:",t),console.error("Failed to initialize MuseFlow backend:",t)}}Ve();chrome.runtime.onInstalled.addListener(t=>{console.log("[MuseFlow] Extension installed/updated:",t.reason),chrome.contextMenus.create({id:"museflow-summarize",title:"Summarize with MuseFlow",contexts:["selection"]}),chrome.contextMenus.create({id:"museflow-rewrite",title:"Rewrite with MuseFlow",contexts:["selection"]}),chrome.contextMenus.create({id:"museflow-ideate",title:"Ideate with MuseFlow",contexts:["selection"]}),chrome.contextMenus.create({id:"museflow-translate",title:"Translate with MuseFlow",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener((t,e)=>{var a;if(!t.selectionText||!(e!=null&&e.id))return;const n=(a=t.menuItemId)==null?void 0:a.replace("museflow-","");n&&["summarize","rewrite","ideate","translate"].includes(n)&&chrome.tabs.sendMessage(e.id,{type:"TRIGGER_ACTION",action:n,text:t.selectionText,source:"contextMenu"}).catch(r=>{console.error("[MuseFlow] Failed to send message to content script:",r)})});chrome.runtime.onMessage.addListener((t,e,n)=>(console.log("[MuseFlow] Message received:",t),G(t,e,n).catch(a=>{console.error("[MuseFlow] Error handling message:",a),n({success:!1,error:a.message||"Unknown error occurred"})}),!0));
